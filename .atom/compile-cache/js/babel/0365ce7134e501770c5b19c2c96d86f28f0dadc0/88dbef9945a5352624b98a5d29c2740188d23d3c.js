//////////////////
// Requires
//////////////////

var Promise = require('bluebird');
var exec = require('child_process').exec;

var Queue = require('./../queue/Queue');
var Action = require('./../queue/Action');
var Directory = require('./../filesystem/Directory');

var ConnectionErrorException = require('./../exceptions/ConnectionErrorException');
var DirectoryCreationErrorException = require('./../exceptions/DirectoryCreationErrorException');
var RemoteDirectoryNotReadableException = require('./../exceptions/RemoteDirectoryNotReadableException');

//////////////////
// Ctor
//////////////////

function Connection(config) {
    this.config = config ? config : null;
    this.connection = null;
    this.queue = new Queue(3);
}

//////////////////
// Methods
//////////////////

Connection.prototype.getConnectionInformations = function () {
    throw 'Method non implemented';
};

Connection.prototype.createRemoteDirectory = function (directoryPath) {
    throw 'Method non implemented';
};

/**
 * @TODO: Change exec to proper way
 */
Connection.prototype.createDirectory = function (directoryPath) {
    var deferred = Promise.pending();

    try {
        exec('mkdir -p ' + directoryPath, function (err) {
            if (err) {
                deferred.reject(new DirectoryCreationErrorException(directoryPath));
                return;
            }

            deferred.resolve(directoryPath);
        });
    } catch (e) {
        deferred.reject(e);
    }

    return deferred.promise;
};

Connection.prototype.uploadFile = function (file) {
    throw 'Method non implemented';
};

Connection.prototype.downloadFile = function (file) {
    throw 'Method non implemented';
};

Connection.prototype.connect = function () {
    var self = this;
    var deferred = Promise.pending();

    this.connection.on('ready', function () {
        deferred.resolve(self);
    });

    this.connection.on('error', function (err) {
        deferred.reject(new ConnectionErrorException(err.message));
    });

    try {
        this.connection.connect(this.getConnectionInformations());
    } catch (e) {
        deferred.reject(new ConnectionErrorException(e.message));
    }

    return deferred.promise;
};

Connection.prototype.close = function () {
    var deferred = Promise.pending();

    try {
        this.connection.end();
        deferred.resolve(true);
    } catch (e) {
        deferred.reject(e);
    }

    return deferred.promise;
};

/**
 * @param  {File[]} files
 */
Connection.prototype.upload = function (files) {
    var self = this;
    var deferred = Promise.pending();

    try {
        for (var i in files) {
            this.queue.addAction(new Action(self, self.uploadFile, [files[i]]));
        }

        this.queue.execute(function () {
            deferred.resolve(self);
        }, function (e) {
            deferred.reject(e);
        });
    } catch (e) {
        deferred.reject(e);
    }

    return deferred.promise;
};

/**
 * @param  {File[]} aFiles
 */
Connection.prototype.download = function (files) {
    var self = this;
    var deferred = Promise.pending();

    try {
        for (var i in files) {
            this.queue.addAction(new Action(self, self.downloadFile, [files[i]]));
        }

        this.queue.execute(function () {
            deferred.resolve(self);
        }, function (e) {
            deferred.reject(e);
        });
    } catch (e) {
        deferred.reject(e);
    }

    return deferred.promise;
};

Connection.prototype.extractDistantFiles = function (node, files) {};

/**
 * @param  {File[]} aFiles
 */
Connection.prototype.getTargetFiles = function (nodes) {
    var self = this;
    var deferred = Promise.pending();

    var files = [];
    var calls = [];

    try {
        for (var i in nodes) {
            var node = nodes[i];
            calls.push(this.extractDistantFiles(node, files));
        }

        Promise.all(calls).then(function () {
            deferred.resolve(files);
        })['catch'](RemoteDirectoryNotReadableException, function (e) {
            deferred.reject(e);
        });
    } catch (e) {
        deferred.reject(e);
    }

    return deferred.promise;
};

module.exports = Connection;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9zc3VuLy5hdG9tL3BhY2thZ2VzL3NmdHAtZGVwbG95bWVudC9saWIvY29ubmVjdGlvbnMvQ29ubmVjdGlvbi5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBSUEsSUFBSSxPQUFPLEdBQUcsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0FBQ2xDLElBQUksSUFBSSxHQUFHLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQyxJQUFJLENBQUM7O0FBRXpDLElBQUksS0FBSyxHQUFHLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO0FBQ3hDLElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO0FBQzFDLElBQUksU0FBUyxHQUFHLE9BQU8sQ0FBQywyQkFBMkIsQ0FBQyxDQUFDOztBQUVyRCxJQUFJLHdCQUF3QixHQUFHLE9BQU8sQ0FBQywwQ0FBMEMsQ0FBQyxDQUFDO0FBQ25GLElBQUksK0JBQStCLEdBQUcsT0FBTyxDQUFDLGlEQUFpRCxDQUFDLENBQUM7QUFDakcsSUFBSSxtQ0FBbUMsR0FBRyxPQUFPLENBQUMscURBQXFELENBQUMsQ0FBQzs7Ozs7O0FBTXpHLFNBQVMsVUFBVSxDQUFDLE1BQU0sRUFBRTtBQUN4QixRQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sR0FBRyxNQUFNLEdBQUcsSUFBSSxDQUFDO0FBQ3JDLFFBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDO0FBQ3ZCLFFBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7Q0FDN0I7Ozs7OztBQU1ELFVBQVUsQ0FBQyxTQUFTLENBQUMseUJBQXlCLEdBQUcsWUFBVztBQUN4RCxVQUFNLHdCQUF3QixDQUFDO0NBQ2xDLENBQUE7O0FBRUQsVUFBVSxDQUFDLFNBQVMsQ0FBQyxxQkFBcUIsR0FBRyxVQUFTLGFBQWEsRUFBRTtBQUNqRSxVQUFNLHdCQUF3QixDQUFDO0NBQ2xDLENBQUE7Ozs7O0FBS0EsVUFBVSxDQUFD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QixHQUFHLFVBQVMsSUFBSSxFQUFFLEtBQUssRUFBRSxFQUNoRSxDQUFBOzs7OztBQUtBLFVBQVUsQ0FBQyxTQUFTLENBQUMsY0FBYyxHQUFHLFVBQVMsS0FBSyxFQUFFO0FBQ25ELFFBQUksSUFBSSxHQUFHLElBQUksQ0FBQztBQUNoQixRQUFJLFFBQVEsR0FBRyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUM7O0FBRWpDLFFBQUksS0FBSyxHQUFHLEVBQUUsQ0FBQztBQUNmLFFBQUksS0FBSyxHQUFHLEVBQUUsQ0FBQzs7QUFFZixRQUFJO0FBQ0EsYUFBSyxJQUFJLENBQUMsSUFBSSxLQUFLLEVBQUU7QUFDakIsZ0JBQUksSUFBSSxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNwQixpQkFBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUM7U0FDckQ7O0FBRUQsZUFBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FDYixJQUFJLENBQUMsWUFBVztBQUNiLG9CQUFRLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQzNCLENBQUMsU0FDSSxDQUFDLG1DQUFtQyxFQUFFLFVBQVMsQ0FBQyxFQUFFO0FBQ3BELG9CQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ3RCLENBQUMsQ0FBQztLQUNWLENBQUMsT0FBTSxDQUFDLEVBQUU7QUFDUCxnQkFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztLQUN0Qjs7QUFFRCxXQUFPLFFBQVEsQ0FBQyxPQUFPLENBQUM7Q0FDM0IsQ0FBQTs7QUFFRCxNQUFNLENBQUMsT0FBTyxHQUFHLFVBQVUsQ0FBQyIsImZpbGUiOiIvVXNlcnMvc3N1bi8uYXRvbS9wYWNrYWdlcy9zZnRwLWRlcGxveW1lbnQvbGliL2Nvbm5lY3Rpb25zL0Nvbm5lY3Rpb24uanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLy8vLy8vLy8vLy8vLy8vLy9cbi8vIFJlcXVpcmVzXG4vLy8vLy8vLy8vLy8vLy8vLy9cblxudmFyIFByb21pc2UgPSByZXF1aXJlKCdibHVlYmlyZCcpO1xudmFyIGV4ZWMgPSByZXF1aXJlKCdjaGlsZF9wcm9jZXNzJykuZXhlYztcblxudmFyIFF1ZXVlID0gcmVxdWlyZSgnLi8uLi9xdWV1ZS9RdWV1ZScpO1xudmFyIEFjdGlvbiA9IHJlcXVpcmUoJy4vLi4vcXVldWUvQWN0aW9uJyk7XG52YXIgRGlyZWN0b3J5ID0gcmVxdWlyZSgnLi8uLi9maWxlc3lzdGVtL0RpcmVjdG9yeScpO1xuXG52YXIgQ29ubmVjdGlvbkVycm9yRXhjZXB0aW9uID0gcmVxdWlyZSgnLi8uLi9leGNlcHRpb25zL0Nvbm5lY3Rpb25FcnJvckV4Y2VwdGlvbicpO1xudmFyIERpcmVjdG9yeUNyZWF0aW9uRXJyb3JFeGNlcHRpb24gPSByZXF1aXJlKCcuLy4uL2V4Y2VwdGlvbnMvRGlyZWN0b3J5Q3JlYXRpb25FcnJvckV4Y2VwdGlvbicpO1xudmFyIFJlbW90ZURpcmVjdG9yeU5vdFJlYWRhYmxlRXhjZXB0aW9uID0gcmVxdWlyZSgnLi8uLi9leGNlcHRpb25zL1JlbW90ZURpcmVjdG9yeU5vdFJlYWRhYmxlRXhjZXB0aW9uJyk7XG5cbi8vLy8vLy8vLy8vLy8vLy8vL1xuLy8gQ3RvclxuLy8vLy8vLy8vLy8vLy8vLy8vXG5cbmZ1bmN0aW9uIENvbm5lY3Rpb24oY29uZmlnKSB7XG4gICAgdGhpcy5jb25maWcgPSBjb25maWcgPyBjb25maWcgOiBudWxsO1xuICAgIHRoaXMuY29ubmVjdGlvbiA9IG51bGw7XG4gICAgdGhpcy5xdWV1ZSA9IG5ldyBRdWV1ZSgzKTtcbn1cblxuLy8vLy8vLy8vLy8vLy8vLy8vXG4vLyBNZXRob2RzXG4vLy8vLy8vLy8vLy8vLy8vLy9cblxuQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0Q29ubmVjdGlvbkluZm9ybWF0aW9ucyA9IGZ1bmN0aW9uKCkge1xuICAgIHRocm93IFwiTWV0aG9kIG5vbiBpbXBsZW1lbnRlZFwiO1xufVxuXG5Db25uZWN0aW9uLnByb3RvdHlwZS5jcmVhdGVSZW1vdGVEaXJlY3RvcnkgPSBmdW5jdGlvbihkaXJlY3RvcnlQYXRoKSB7XG4gICAgdGhyb3cgXCJNZXRob2Qgbm9uIGltcGxlbWVudGVkXCI7XG59XG5cbi8qKlxuICogQFRPRE86IENoYW5nZSBleGVjIHRvIHByb3BlciB3YXlcbiAqL1xuIENvbm5lY3Rpb24ucHJvdG90eXBlLmNyZWF0ZURpcmVjdG9yeSA9IGZ1bmN0aW9uKGRpcmVjdG9yeVBhdGgpIHtcbiAgICB2YXIgZGVmZXJyZWQgPSBQcm9taXNlLnBlbmRpbmcoKTtcblxuICAgIHRyeSB7XG4gICAgICAgIGV4ZWMoXG4gICAgICAgICAgICAnbWtkaXIgLXAgJyArIGRpcmVjdG9yeVBhdGgsXG4gICAgICAgICAgICBmdW5jdGlvbiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZWplY3QobmV3IERpcmVjdG9yeUNyZWF0aW9uRXJyb3JFeGNlcHRpb24oZGlyZWN0b3J5UGF0aCkpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShkaXJlY3RvcnlQYXRoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICB9IGNhdGNoKGUpIHtcbiAgICAgICAgZGVmZXJyZWQucmVqZWN0KGUpO1xuICAgIH1cblxuICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlO1xufVxuXG5Db25uZWN0aW9uLnByb3RvdHlwZS51cGxvYWRGaWxlID0gZnVuY3Rpb24oZmlsZSkge1xuICAgIHRocm93IFwiTWV0aG9kIG5vbiBpbXBsZW1lbnRlZFwiO1xufVxuXG5Db25uZWN0aW9uLnByb3RvdHlwZS5kb3dubG9hZEZpbGUgPSBmdW5jdGlvbihmaWxlKSB7XG4gICAgdGhyb3cgXCJNZXRob2Qgbm9uIGltcGxlbWVudGVkXCI7XG59XG5cbkNvbm5lY3Rpb24ucHJvdG90eXBlLmNvbm5lY3QgPSBmdW5jdGlvbigpIHtcbiAgICB2YXIgc2VsZiA9IHRoaXM7XG4gICAgdmFyIGRlZmVycmVkID0gUHJvbWlzZS5wZW5kaW5nKCk7XG5cbiAgICB0aGlzLmNvbm5lY3Rpb24ub24oJ3JlYWR5JywgZnVuY3Rpb24oKSB7XG4gICAgICAgIGRlZmVycmVkLnJlc29sdmUoc2VsZik7XG4gICAgfSk7XG5cbiAgICB0aGlzLmNvbm5lY3Rpb24ub24oJ2Vycm9yJywgZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgIGRlZmVycmVkLnJlamVjdChuZXcgQ29ubmVjdGlvbkVycm9yRXhjZXB0aW9uKGVyci5tZXNzYWdlKSk7XG4gICAgfSk7XG5cbiAgICB0cnkge1xuICAgICAgICB0aGlzLmNvbm5lY3Rpb24uY29ubmVjdCh0aGlzLmdldENvbm5lY3Rpb25JbmZvcm1hdGlvbnMoKSk7XG4gICAgfSBjYXRjaChlKSB7XG4gICAgICAgIGRlZmVycmVkLnJlamVjdChuZXcgQ29ubmVjdGlvbkVycm9yRXhjZXB0aW9uKGUubWVzc2FnZSkpO1xuICAgIH1cblxuICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlO1xufVxuXG5Db25uZWN0aW9uLnByb3RvdHlwZS5jbG9zZSA9IGZ1bmN0aW9uKCkge1xuICAgIHZhciBkZWZlcnJlZCA9IFByb21pc2UucGVuZGluZygpO1xuXG4gICAgdHJ5IHtcbiAgICAgICAgdGhpcy5jb25uZWN0aW9uLmVuZCgpO1xuICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKHRydWUpO1xuICAgIH0gY2F0Y2goZSkge1xuICAgICAgICBkZWZlcnJlZC5yZWplY3QoZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7XG59XG5cbi8qKlxuICogQHBhcmFtICB7RmlsZVtdfSBmaWxlc1xuICovXG4gQ29ubmVjdGlvbi5wcm90b3R5cGUudXBsb2FkID0gZnVuY3Rpb24oZmlsZXMpIHtcbiAgICB2YXIgc2VsZiA9IHRoaXM7XG4gICAgdmFyIGRlZmVycmVkID0gUHJvbWlzZS5wZW5kaW5nKCk7XG5cbiAgICB0cnkge1xuICAgICAgICBmb3IgKHZhciBpIGluIGZpbGVzKSB7XG4gICAgICAgICAgICB0aGlzLnF1ZXVlLmFkZEFjdGlvbihuZXcgQWN0aW9uKFxuICAgICAgICAgICAgICAgIHNlbGYsXG4gICAgICAgICAgICAgICAgc2VsZi51cGxvYWRGaWxlLFxuICAgICAgICAgICAgICAgIFtmaWxlc1tpXV1cbiAgICAgICAgICAgICkpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5xdWV1ZS5leGVjdXRlKFxuICAgICAgICAgICAgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShzZWxmKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBmdW5jdGlvbihlKSB7XG4gICAgICAgICAgICAgICAgZGVmZXJyZWQucmVqZWN0KGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICApO1xuICAgIH0gY2F0Y2goZSkge1xuICAgICAgICBkZWZlcnJlZC5yZWplY3QoZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7XG59XG5cbi8qKlxuICogQHBhcmFtICB7RmlsZVtdfSBhRmlsZXNcbiAqL1xuIENvbm5lY3Rpb24ucHJvdG90eXBlLmRvd25sb2FkID0gZnVuY3Rpb24oZmlsZXMpIHtcbiAgICB2YXIgc2VsZiA9IHRoaXM7XG4gICAgdmFyIGRlZmVycmVkID0gUHJvbWlzZS5wZW5kaW5nKCk7XG5cbiAgICB0cnkge1xuICAgICAgICBmb3IgKHZhciBpIGluIGZpbGVzKSB7XG4gICAgICAgICAgICB0aGlzLnF1ZXVlLmFkZEFjdGlvbihuZXcgQWN0aW9uKFxuICAgICAgICAgICAgICAgIHNlbGYsXG4gICAgICAgICAgICAgICAgc2VsZi5kb3dubG9hZEZpbGUsXG4gICAgICAgICAgICAgICAgW2ZpbGVzW2ldXVxuICAgICAgICAgICAgKSk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnF1ZXVlLmV4ZWN1dGUoXG4gICAgICAgICAgICBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKHNlbGYpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZWplY3QoZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICk7XG4gICAgfSBjYXRjaChlKSB7XG4gICAgICAgIGRlZmVycmVkLnJlamVjdChlKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZTtcbn1cblxuQ29ubmVjdGlvbi5wcm90b3R5cGUuZXh0cmFjdERpc3RhbnRGaWxlcyA9IGZ1bmN0aW9uKG5vZGUsIGZpbGVzKSB7XG59XG5cbi8qKlxuICogQHBhcmFtICB7RmlsZVtdfSBhRmlsZXNcbiAqL1xuIENvbm5lY3Rpb24ucHJvdG90eXBlLmdldFRhcmdldEZpbGVzID0gZnVuY3Rpb24obm9kZXMpIHtcbiAgICB2YXIgc2VsZiA9IHRoaXM7XG4gICAgdmFyIGRlZmVycmVkID0gUHJvbWlzZS5wZW5kaW5nKCk7XG5cbiAgICB2YXIgZmlsZXMgPSBbXTtcbiAgICB2YXIgY2FsbHMgPSBbXTtcblxuICAgIHRyeSB7XG4gICAgICAgIGZvciAodmFyIGkgaW4gbm9kZXMpIHtcbiAgICAgICAgICAgIHZhciBub2RlID0gbm9kZXNbaV07XG4gICAgICAgICAgICBjYWxscy5wdXNoKHRoaXMuZXh0cmFjdERpc3RhbnRGaWxlcyhub2RlLCBmaWxlcykpO1xuICAgICAgICB9XG5cbiAgICAgICAgUHJvbWlzZS5hbGwoY2FsbHMpXG4gICAgICAgICAgICAudGhlbihmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKGZpbGVzKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAuY2F0Y2goUmVtb3RlRGlyZWN0b3J5Tm90UmVhZGFibGVFeGNlcHRpb24sIGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZWplY3QoZSk7XG4gICAgICAgICAgICB9KTtcbiAgICB9IGNhdGNoKGUpIHtcbiAgICAgICAgZGVmZXJyZWQucmVqZWN0KGUpO1xuICAgIH1cblxuICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IENvbm5lY3Rpb247XG4iXX0=