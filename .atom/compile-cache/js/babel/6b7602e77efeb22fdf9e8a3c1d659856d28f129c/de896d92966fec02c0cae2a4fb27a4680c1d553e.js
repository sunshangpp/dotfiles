//////////////////
// Requires
//////////////////

var util = require('util');
var path = require('path');
var fs = require('fs');
var FTPConnection = require('ftp');
var Promise = require('bluebird');

var Connection = require('./Connection');
var Directory = require('./../filesystem/Directory');
var File = require('./../filesystem/File');

var UploadErrorException = require('./../exceptions/UploadErrorException');
var DownloadErrorException = require('./../exceptions/DownloadErrorException');
var RemoteDirectoryCreationErrorException = require('./../exceptions/RemoteDirectoryCreationErrorException');
var TransfertErrorException = require('./../exceptions/TransfertErrorException');
var RemoteDirectoryNotReadableException = require('./../exceptions/RemoteDirectoryNotReadableException');

//////////////////
// Ctor
//////////////////

function FtpConnection(config) {
    Connection.apply(this, [config]);

    this.connection = new FTPConnection();
}

util.inherits(FtpConnection, Connection);

//////////////////
// Methods
//////////////////

FtpConnection.prototype.getConnectionInformations = function () {
    var self = this;

    return {
        host: self.config.host,
        port: self.config.port ? self.config.port : 21,
        user: self.config.username,
        password: self.config.password
    };
};

FtpConnection.prototype.createRemoteDirectory = function (directoryPath) {
    var deferred = Promise.pending();

    try {
        this.connection.mkdir(directoryPath, true, function (err) {
            if (err) {
                deferred.reject(new RemoteDirectoryCreationErrorException(directoryPath));
            }

            deferred.resolve(directoryPath);
        });
    } catch (e) {
        deferred.reject(e);
    }

    return deferred.promise;
};

FtpConnection.prototype.put = function (sourceFile, destinationFile) {
    var deferred = Promise.pending();

    try {
        this.connection.put(sourceFile, destinationFile, function (err) {
            if (err) {
                if (err.code === 550) {
                    deferred.reject(new UploadErrorException(sourceFile, 'Permission denied'));
                } else {
                    deferred.reject(err);
                }
                return;
            }

            deferred.resolve();
        });
    } catch (e) {
        deferred.reject(e);
    }

    return deferred.promise;
};

FtpConnection.prototype.get = function (sourceFile, destinationFile) {
    var deferred = Promise.pending();

    try {
        this.connection.get(sourceFile, function (err, stream) {
            if (err) {
                if (err.code === 550) {
                    deferred.reject(new DownloadErrorException(destinationFile, 'Permission denied'));
                } else if (err.code === 425) {
                    deferred.reject(new TransfertErrorException(sourceFile, err.message));
                } else {
                    deferred.reject(err);
                }
                return;
            }

            var outFileStream = fs.createWriteStream(destinationFile);
            outFileStream.once('error', function (e) {
                deferred.reject(new DownloadErrorException(destinationFile, 'Permission denied'));
            });
            stream.once('close', function () {
                deferred.resolve();
            });
            stream.pipe(outFileStream);
        });
    } catch (e) {
        deferred.reject(e);
    }

    return deferred.promise;
};

FtpConnection.prototype.uploadFile = function (file) {
    var deferred = Promise.pending();
    var self = this;
    var destinationFile = path.join(this.config.getRemotePath(), file.getRelativePath()).replace(/\\/g, '/');

    try {
        this.createRemoteDirectory(path.dirname(destinationFile)).then(function (directory) {
            return self.put(file.getPath(), destinationFile);
        }).then(function () {
            deferred.resolve(file);
        })['catch'](function (e) {
            deferred.reject(e);
        });
    } catch (e) {
        deferred.reject(e);
    }

    return deferred.promise;
};

FtpConnection.prototype.downloadFile = function (file) {
    var deferred = Promise.pending();
    var self = this;
    var sourceFile = path.join(this.config.getRemotePath(), file.getRelativePath()).replace(/\\/g, '/');

    try {
        this.createDirectory(file.getDirectory()).then(function (directory) {
            return self.get(sourceFile, file.getPath());
        }).then(function () {
            deferred.resolve(file);
        })['catch'](function (e) {
            deferred.reject(e);
        });
    } catch (e) {
        deferred.reject(e);
    }

    return deferred.promise;
};

FtpConnection.prototype.extractDistantFiles = function (node, files) {
    var deferred = Promise.pending();
    var self = this;

    try {
        if (node instanceof Directory) {
            var remotePath = path.join(this.config.getRemotePath(), node.getRelativePath()).replace(/\\/g, '/');

            this.connection.list(remotePath, function (err, nodes) {
                if (err) {
                    deferred.reject(new RemoteDirectoryNotReadableException(remotePath));
                }

                var calls = [];

                for (var i in nodes) {
                    if (nodes[i].type === 'd') {
                        calls.push(self.extractDistantFiles(new Directory(path.join(node.getRelativePath(), nodes[i].name), true), files));
                    } else {
                        calls.push(self.extractDistantFiles(new File(path.join(node.getRelativePath(), nodes[i].name), true), files));
                    }
                }

                Promise.all(calls).then(function () {
                    deferred.resolve();
                })['catch'](function (e) {
                    deferred.reject(e);
                });
            });
        } else {
            files.push(node);
            deferred.resolve();
        }
    } catch (e) {
        deferred.reject(e);
    }

    return deferred.promise;
};

module.exports = FtpConnection;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9zc3VuLy5hdG9tL3BhY2thZ2VzL3NmdHAtZGVwbG95bWVudC9saWIvY29ubmVjdGlvbnMvRnRwQ29ubmVjdGlvbi5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBSUEsSUFBSSxJQUFJLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQzNCLElBQUksSUFBSSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUMzQixJQUFJLEVBQUUsR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDdkIsSUFBSSxhQUFhLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQ25DLElBQUksT0FBTyxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQzs7QUFFbEMsSUFBSSxVQUFVLEdBQUcsT0FBTyxDQUFDLGNBQWMsQ0FBQyxDQUFDO0FBQ3pDLElBQUksU0FBUyxHQUFHLE9BQU8sQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO0FBQ3JELElBQUksSUFBSSxHQUFHLE9BQU8sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDOztBQUUzQyxJQUFJLG9CQUFvQixHQUFHLE9BQU8sQ0FBQyxzQ0FBc0MsQ0FBQyxDQUFDO0FBQzNFLElBQUksc0JBQXNCLEdBQUcsT0FBTyxDQUFDLHdDQUF3QyxDQUFDLENBQUM7QUFDL0UsSUFBSSxxQ0FBcUMsR0FBRyxPQUFPLENBQUMsdURBQXVELENBQUMsQ0FBQztBQUM3RyxJQUFJLHVCQUF1QixHQUFHLE9BQU8sQ0FBQyx5Q0FBeUMsQ0FBQyxDQUFDO0FBQ2pGLElBQUksbUNBQW1DLEdBQUcsT0FBTyxDQUFDLHFEQUFxRCxDQUFDLENBQUM7Ozs7OztBQU16RyxTQUFTLGFBQWEsQ0FBQyxNQUFNLEVBQUU7QUFDM0IsY0FBVSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDOztBQUVqQyxRQUFJLENBQUMsVUFBVSxHQUFHLElBQUksYUFBYSxFQUFFLENBQUM7Q0FD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QUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDO3FCQUN0SCxNQUFNO0FBQ0gsNkJBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDO3FCQUNqSDtpQkFDSjs7QUFFRCx1QkFBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsWUFBVztBQUMvQiw0QkFBUSxDQUFDLE9BQU8sRUFBRSxDQUFDO2lCQUN0QixDQUFDLFNBQ0ksQ0FBQyxVQUFTLENBQUMsRUFBRTtBQUNmLDRCQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO2lCQUN0QixDQUFDLENBQUM7YUFDTixDQUFDLENBQUE7U0FDTCxNQUFNO0FBQ0osaUJBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDakIsb0JBQVEsQ0FBQyxPQUFPLEVBQUUsQ0FBQztTQUNyQjtLQUNKLENBQUMsT0FBTSxDQUFDLEVBQUU7QUFDUCxnQkFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztLQUN0Qjs7QUFFRCxXQUFPLFFBQVEsQ0FBQyxPQUFPLENBQUM7Q0FDM0IsQ0FBQTs7QUFFRCxNQUFNLENBQUMsT0FBTyxHQUFHLGFBQWEsQ0FBQyIsImZpbGUiOiIvVXNlcnMvc3N1bi8uYXRvbS9wYWNrYWdlcy9zZnRwLWRlcGxveW1lbnQvbGliL2Nvbm5lY3Rpb25zL0Z0cENvbm5lY3Rpb24uanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLy8vLy8vLy8vLy8vLy8vLy9cbi8vIFJlcXVpcmVzXG4vLy8vLy8vLy8vLy8vLy8vLy9cblxudmFyIHV0aWwgPSByZXF1aXJlKCd1dGlsJyk7XG52YXIgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbnZhciBmcyA9IHJlcXVpcmUoJ2ZzJyk7XG52YXIgRlRQQ29ubmVjdGlvbiA9IHJlcXVpcmUoJ2Z0cCcpO1xudmFyIFByb21pc2UgPSByZXF1aXJlKCdibHVlYmlyZCcpO1xuXG52YXIgQ29ubmVjdGlvbiA9IHJlcXVpcmUoJy4vQ29ubmVjdGlvbicpO1xudmFyIERpcmVjdG9yeSA9IHJlcXVpcmUoJy4vLi4vZmlsZXN5c3RlbS9EaXJlY3RvcnknKTtcbnZhciBGaWxlID0gcmVxdWlyZSgnLi8uLi9maWxlc3lzdGVtL0ZpbGUnKTtcblxudmFyIFVwbG9hZEVycm9yRXhjZXB0aW9uID0gcmVxdWlyZSgnLi8uLi9leGNlcHRpb25zL1VwbG9hZEVycm9yRXhjZXB0aW9uJyk7XG52YXIgRG93bmxvYWRFcnJvckV4Y2VwdGlvbiA9IHJlcXVpcmUoJy4vLi4vZXhjZXB0aW9ucy9Eb3dubG9hZEVycm9yRXhjZXB0aW9uJyk7XG52YXIgUmVtb3RlRGlyZWN0b3J5Q3JlYXRpb25FcnJvckV4Y2VwdGlvbiA9IHJlcXVpcmUoJy4vLi4vZXhjZXB0aW9ucy9SZW1vdGVEaXJlY3RvcnlDcmVhdGlvbkVycm9yRXhjZXB0aW9uJyk7XG52YXIgVHJhbnNmZXJ0RXJyb3JFeGNlcHRpb24gPSByZXF1aXJlKCcuLy4uL2V4Y2VwdGlvbnMvVHJhbnNmZXJ0RXJyb3JFeGNlcHRpb24nKTtcbnZhciBSZW1vdGVEaXJlY3RvcnlOb3RSZWFkYWJsZUV4Y2VwdGlvbiA9IHJlcXVpcmUoJy4vLi4vZXhjZXB0aW9ucy9SZW1vdGVEaXJlY3RvcnlOb3RSZWFkYWJsZUV4Y2VwdGlvbicpO1xuXG4vLy8vLy8vLy8vLy8vLy8vLy9cbi8vIEN0b3Jcbi8vLy8vLy8vLy8vLy8vLy8vL1xuXG5mdW5jdGlvbiBGdHBDb25uZWN0aW9uKGNvbmZpZykge1xuICAgIENvbm5lY3Rpb24uYXBwbHkodGhpcywgW2NvbmZpZ10pO1xuXG4gICAgdGhpcy5jb25uZWN0aW9uID0gbmV3IEZUUENvbm5lY3Rpb24oKTtcbn1cblxudXRpbC5pbmhlcml0cyhGdHBDb25uZWN0aW9uLCBDb25uZWN0aW9uKTtcblxuLy8vLy8vLy8vLy8vLy8vLy8vXG4vLyBNZXRob2RzXG4vLy8vLy8vLy8vLy8vLy8vLy9cblxuRnRwQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0Q29ubmVjdGlvbkluZm9ybWF0aW9ucyA9IGZ1bmN0aW9uKCkge1xuICAgIHZhciBzZWxmID0gdGhpcztcblxuICAgIHJldHVybiB7XG4gICAgICAgIGhvc3Q6IHNlbGYuY29uZmlnLmhvc3QsXG4gICAgICAgIHBvcnQ6IHNlbGYuY29uZmlnLnBvcnQgPyBzZWxmLmNvbmZpZy5wb3J0IDogMjEsXG4gICAgICAgIHVzZXI6IHNlbGYuY29uZmlnLnVzZXJuYW1lLFxuICAgICAgICBwYXNzd29yZDogc2VsZi5jb25maWcucGFzc3dvcmRcbiAgICB9O1xufVxuXG5cbkZ0cENvbm5lY3Rpb24ucHJvdG90eXBlLmNyZWF0ZVJlbW90ZURpcmVjdG9yeSA9IGZ1bmN0aW9uKGRpcmVjdG9yeVBhdGgpIHtcbiAgICB2YXIgZGVmZXJyZWQgPSBQcm9taXNlLnBlbmRpbmcoKTtcblxuICAgIHRyeSB7XG4gICAgICAgIHRoaXMuY29ubmVjdGlvbi5ta2RpcihcbiAgICAgICAgICAgIGRpcmVjdG9yeVBhdGgsXG4gICAgICAgICAgICB0cnVlLFxuICAgICAgICAgICAgZnVuY3Rpb24gKGVycikge1xuICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgZGVmZXJyZWQucmVqZWN0KG5ldyBSZW1vdGVEaXJlY3RvcnlDcmVhdGlvbkVycm9yRXhjZXB0aW9uKGRpcmVjdG9yeVBhdGgpKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKGRpcmVjdG9yeVBhdGgpO1xuICAgICAgICAgICAgfVxuICAgICAgICApO1xuICAgIH0gY2F0Y2goZSkge1xuICAgICAgICBkZWZlcnJlZC5yZWplY3QoZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7XG59XG5cbkZ0cENvbm5lY3Rpb24ucHJvdG90eXBlLnB1dCA9IGZ1bmN0aW9uKHNvdXJjZUZpbGUsIGRlc3RpbmF0aW9uRmlsZSkge1xuICAgIHZhciBkZWZlcnJlZCA9IFByb21pc2UucGVuZGluZygpO1xuXG4gICAgdHJ5IHtcbiAgICAgICAgdGhpcy5jb25uZWN0aW9uLnB1dChzb3VyY2VGaWxlLCBkZXN0aW5hdGlvbkZpbGUsIGZ1bmN0aW9uKGVycikge1xuICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgIGlmIChlcnIuY29kZSA9PT0gNTUwKSB7XG4gICAgICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdChuZXcgVXBsb2FkRXJyb3JFeGNlcHRpb24oc291cmNlRmlsZSwgJ1Blcm1pc3Npb24gZGVuaWVkJykpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdChlcnIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUoKTtcbiAgICAgICAgfSk7XG4gICAgfSBjYXRjaChlKSB7XG4gICAgICAgIGRlZmVycmVkLnJlamVjdChlKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZTtcbn1cblxuRnRwQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24oc291cmNlRmlsZSwgZGVzdGluYXRpb25GaWxlKSB7XG4gICAgdmFyIGRlZmVycmVkID0gUHJvbWlzZS5wZW5kaW5nKCk7XG5cbiAgICB0cnkge1xuICAgICAgICB0aGlzLmNvbm5lY3Rpb24uZ2V0KHNvdXJjZUZpbGUsIGZ1bmN0aW9uKGVyciwgc3RyZWFtKSB7XG4gICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgaWYgKGVyci5jb2RlID09PSA1NTApIHtcbiAgICAgICAgICAgICAgICAgICAgZGVmZXJyZWQucmVqZWN0KG5ldyBEb3dubG9hZEVycm9yRXhjZXB0aW9uKGRlc3RpbmF0aW9uRmlsZSwgJ1Blcm1pc3Npb24gZGVuaWVkJykpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZXJyLmNvZGUgPT09IDQyNSkge1xuICAgICAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZWplY3QobmV3IFRyYW5zZmVydEVycm9yRXhjZXB0aW9uKHNvdXJjZUZpbGUsIGVyci5tZXNzYWdlKSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgZGVmZXJyZWQucmVqZWN0KGVycik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdmFyIG91dEZpbGVTdHJlYW0gPSBmcy5jcmVhdGVXcml0ZVN0cmVhbShkZXN0aW5hdGlvbkZpbGUpO1xuICAgICAgICAgICAgb3V0RmlsZVN0cmVhbS5vbmNlKCdlcnJvcicsIGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZWplY3QobmV3IERvd25sb2FkRXJyb3JFeGNlcHRpb24oZGVzdGluYXRpb25GaWxlLCAnUGVybWlzc2lvbiBkZW5pZWQnKSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHN0cmVhbS5vbmNlKCdjbG9zZScsIGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUoKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgc3RyZWFtLnBpcGUob3V0RmlsZVN0cmVhbSk7XG4gICAgICAgIH0pO1xuICAgIH0gY2F0Y2goZSkge1xuICAgICAgICBkZWZlcnJlZC5yZWplY3QoZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7XG59XG5cbkZ0cENvbm5lY3Rpb24ucHJvdG90eXBlLnVwbG9hZEZpbGUgPSBmdW5jdGlvbihmaWxlKSB7XG4gICAgdmFyIGRlZmVycmVkID0gUHJvbWlzZS5wZW5kaW5nKCk7XG4gICAgdmFyIHNlbGYgPSB0aGlzO1xuICAgIHZhciBkZXN0aW5hdGlvbkZpbGUgPSBwYXRoLmpvaW4oXG4gICAgICAgIHRoaXMuY29uZmlnLmdldFJlbW90ZVBhdGgoKSxcbiAgICAgICAgZmlsZS5nZXRSZWxhdGl2ZVBhdGgoKVxuICAgICkucmVwbGFjZSgvXFxcXC9nLCAnLycpO1xuXG4gICAgdHJ5IHtcbiAgICAgICAgdGhpcy5jcmVhdGVSZW1vdGVEaXJlY3RvcnkocGF0aC5kaXJuYW1lKGRlc3RpbmF0aW9uRmlsZSkpXG4gICAgICAgICAgICAudGhlbihmdW5jdGlvbihkaXJlY3RvcnkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gc2VsZi5wdXQoZmlsZS5nZXRQYXRoKCksIGRlc3RpbmF0aW9uRmlsZSk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShmaWxlKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAuY2F0Y2goZnVuY3Rpb24oZSkge1xuICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdChlKTtcbiAgICAgICAgICAgIH0pO1xuICAgIH0gY2F0Y2goZSkge1xuICAgICAgICBkZWZlcnJlZC5yZWplY3QoZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7XG59XG5cbkZ0cENvbm5lY3Rpb24ucHJvdG90eXBlLmRvd25sb2FkRmlsZSA9IGZ1bmN0aW9uKGZpbGUpIHtcbiAgICB2YXIgZGVmZXJyZWQgPSBQcm9taXNlLnBlbmRpbmcoKTtcbiAgICB2YXIgc2VsZiA9IHRoaXM7XG4gICAgdmFyIHNvdXJjZUZpbGUgPSBwYXRoLmpvaW4oXG4gICAgICAgIHRoaXMuY29uZmlnLmdldFJlbW90ZVBhdGgoKSxcbiAgICAgICAgZmlsZS5nZXRSZWxhdGl2ZVBhdGgoKVxuICAgICkucmVwbGFjZSgvXFxcXC9nLCAnLycpO1xuXG4gICAgdHJ5IHtcbiAgICAgICAgdGhpcy5jcmVhdGVEaXJlY3RvcnkoZmlsZS5nZXREaXJlY3RvcnkoKSlcbiAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKGRpcmVjdG9yeSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBzZWxmLmdldChzb3VyY2VGaWxlLCBmaWxlLmdldFBhdGgoKSk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShmaWxlKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAuY2F0Y2goZnVuY3Rpb24oZSkge1xuICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdChlKTtcbiAgICAgICAgICAgIH0pO1xuICAgIH0gY2F0Y2goZSkge1xuICAgICAgICBkZWZlcnJlZC5yZWplY3QoZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7XG59XG5cbkZ0cENvbm5lY3Rpb24ucHJvdG90eXBlLmV4dHJhY3REaXN0YW50RmlsZXMgPSBmdW5jdGlvbihub2RlLCBmaWxlcykge1xuICAgIHZhciBkZWZlcnJlZCA9IFByb21pc2UucGVuZGluZygpO1xuICAgIHZhciBzZWxmID0gdGhpcztcblxuICAgIHRyeSB7XG4gICAgICAgIGlmIChub2RlIGluc3RhbmNlb2YgRGlyZWN0b3J5KSB7XG4gICAgICAgICAgICB2YXIgcmVtb3RlUGF0aCA9IHBhdGguam9pbihcbiAgICAgICAgICAgICAgICB0aGlzLmNvbmZpZy5nZXRSZW1vdGVQYXRoKCksXG4gICAgICAgICAgICAgICAgbm9kZS5nZXRSZWxhdGl2ZVBhdGgoKVxuICAgICAgICAgICAgKS5yZXBsYWNlKC9cXFxcL2csICcvJyk7XG5cbiAgICAgICAgICAgIHRoaXMuY29ubmVjdGlvbi5saXN0KHJlbW90ZVBhdGgsIGZ1bmN0aW9uKGVyciwgbm9kZXMpIHtcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdChuZXcgUmVtb3RlRGlyZWN0b3J5Tm90UmVhZGFibGVFeGNlcHRpb24ocmVtb3RlUGF0aCkpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHZhciBjYWxscyA9IFtdO1xuXG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSBpbiBub2Rlcykge1xuICAgICAgICAgICAgICAgICAgICBpZiAobm9kZXNbaV0udHlwZSA9PT0gJ2QnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjYWxscy5wdXNoKHNlbGYuZXh0cmFjdERpc3RhbnRGaWxlcyhuZXcgRGlyZWN0b3J5KHBhdGguam9pbihub2RlLmdldFJlbGF0aXZlUGF0aCgpLCBub2Rlc1tpXS5uYW1lKSwgdHJ1ZSksIGZpbGVzKSk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjYWxscy5wdXNoKHNlbGYuZXh0cmFjdERpc3RhbnRGaWxlcyhuZXcgRmlsZShwYXRoLmpvaW4obm9kZS5nZXRSZWxhdGl2ZVBhdGgoKSwgbm9kZXNbaV0ubmFtZSksIHRydWUpLCBmaWxlcykpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgUHJvbWlzZS5hbGwoY2FsbHMpLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIC5jYXRjaChmdW5jdGlvbihlKSB7XG4gICAgICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdChlKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgIGZpbGVzLnB1c2gobm9kZSk7XG4gICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUoKTtcbiAgICAgICAgfVxuICAgIH0gY2F0Y2goZSkge1xuICAgICAgICBkZWZlcnJlZC5yZWplY3QoZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7XG59XG5cbm1vZHVsZS5leHBvcnRzID0gRnRwQ29ubmVjdGlvbjtcbiJdfQ==