//////////////////
// Requires
//////////////////

var Promise = require('bluebird');
var util = require('util');
var path = require('path');
var SshConnection = require('ssh2');

var Connection = require('./Connection');
var Directory = require('./../filesystem/Directory');
var File = require('./../filesystem/File');

var UploadErrorException = require('./../exceptions/UploadErrorException');
var DownloadErrorException = require('./../exceptions/DownloadErrorException');
var RemoteDirectoryCreationErrorException = require('./../exceptions/RemoteDirectoryCreationErrorException');
var TransfertErrorException = require('./../exceptions/TransfertErrorException');
var RemoteDirectoryNotReadableException = require('./../exceptions/RemoteDirectoryNotReadableException');

//////////////////
// Ctor
//////////////////

function SftpConnection(config) {
    Connection.apply(this, [config]);

    this.connection = new SshConnection();
}

util.inherits(SftpConnection, Connection);

//////////////////
// Methods
//////////////////

SftpConnection.prototype.getConnectionInformations = function () {
    var self = this;

    var informations = {
        host: self.config.host,
        port: self.config.port ? self.config.port : 22,
        username: self.config.getUsername()
    };

    if (self.config.getPassword()) {
        informations.password = self.config.getPassword();
    } else {
        informations.privateKey = self.config.getSshKeyFile();
        informations.passphrase = self.config.getPassphrase();
    }

    return informations;
};

SftpConnection.prototype.createRemoteDirectory = function (directoryPath) {
    var deferred = Promise.pending();

    try {
        var success = this.connection.exec('mkdir -p ' + directoryPath, function (err, stream) {
            if (err) {
                deferred.reject(new RemoteDirectoryCreationErrorException(directoryPath));
            }

            stream.on('close', function () {
                deferred.resolve(directoryPath);
            });
            stream.stderr.on('data', function (data) {
                deferred.reject(new RemoteDirectoryCreationErrorException(directoryPath));
            });
        });
    } catch (e) {
        deferred.reject(e);
    }

    return deferred.promise;
};

SftpConnection.prototype.openSftp = function () {
    var deferred = Promise.pending();

    try {
        this.connection.sftp(function (err, sftp) {
            if (err) {
                deferred.reject(err);
            }

            deferred.resolve(sftp);
        });
    } catch (e) {
        deferred.reject(e);
    }

    return deferred.promise;
};

SftpConnection.prototype.fastPut = function (sftp, sourceFile, destinationFile) {
    var deferred = Promise.pending();

    try {
        sftp.fastPut(sourceFile, destinationFile, function (err) {
            if (err) {
                deferred.reject(new UploadErrorException(sourceFile, err.message));
            }

            deferred.resolve(sftp);
        });
    } catch (e) {
        deferred.reject(e);
    }

    return deferred.promise;
};

SftpConnection.prototype.fastGet = function (sftp, sourceFile, destinationFile) {
    var deferred = Promise.pending();

    try {
        sftp.fastGet(sourceFile, destinationFile, function (err) {
            if (err) {
                if (err.code === 'EACCES') {
                    deferred.reject(new DownloadErrorException(destinationFile, 'Permission denied'));
                } else {
                    deferred.reject(err);
                }
            }

            deferred.resolve(sftp);
        });
    } catch (e) {
        deferred.reject(e);
    }

    return deferred.promise;
};

SftpConnection.prototype.uploadFile = function (file) {
    var deferred = Promise.pending();
    var self = this;
    var destinationFile = path.join(this.config.getRemotePath(), file.getRelativePath()).replace(/\\/g, '/');

    try {
        this.createRemoteDirectory(path.dirname(destinationFile)).then(function (directory) {
            return self.openSftp();
        }).then(function (sftp) {
            return self.fastPut(sftp, file.getPath(), destinationFile);
        }).then(function (sftp) {
            sftp.end();
            deferred.resolve(file);
        })['catch'](function (e) {
            deferred.reject(e);
        });
    } catch (e) {
        deferred.reject(e);
    }

    return deferred.promise;
};

SftpConnection.prototype.downloadFile = function (file) {
    var deferred = Promise.pending();
    var self = this;
    var sourceFile = path.join(this.config.getRemotePath(), file.getRelativePath()).replace(/\\/g, '/');

    try {
        this.createDirectory(file.getDirectory()).then(function (directory) {
            return self.openSftp();
        }).then(function (sftp) {
            return self.fastGet(sftp, sourceFile, file.getPath());
        }).then(function (sftp) {
            sftp.end();
            deferred.resolve(file);
        })['catch'](function (e) {
            deferred.reject(e);
        });
    } catch (e) {
        deferred.reject(e);
    }

    return deferred.promise;
};

SftpConnection.prototype.getListDir = function (sftp, node, files) {
    var deferred = Promise.pending();
    var self = this;

    try {
        if (node instanceof Directory) {
            var remotePath = path.join(this.config.getRemotePath(), node.getRelativePath()).replace(/\\/g, '/');

            sftp.readdir(remotePath, function (err, nodes) {
                if (err) {
                    deferred.reject(new RemoteDirectoryNotReadableException(remotePath));
                }

                var calls = [];

                for (var i in nodes) {
                    if (nodes[i].attrs.isDirectory()) {
                        calls.push(self.getListDir(sftp, new Directory(path.join(node.getRelativePath(), nodes[i].filename), true), files));
                    } else {
                        calls.push(self.getListDir(sftp, new File(path.join(node.getRelativePath(), nodes[i].filename), true), files));
                    }
                }

                Promise.all(calls).then(function () {
                    deferred.resolve();
                })['catch'](function (e) {
                    deferred.reject(e);
                });
            });
        } else {
            files.push(node);
            deferred.resolve();
        }
    } catch (e) {
        deferred.reject(e);
    }

    return deferred.promise;
};

SftpConnection.prototype.extractDistantFiles = function (node, files) {
    var deferred = Promise.pending();
    var self = this;

    try {
        var sftp = null;
        if (node instanceof Directory) {
            this.openSftp().then(function (_sftp) {
                sftp = _sftp;
                return self.getListDir(_sftp, node, files);
            }).then(function (nodes) {
                sftp.end();
                var calls = [];

                for (var i in nodes) {
                    calls.push(this.extractDistantFiles(nodes[i], files));
                }

                Promise.all(calls).then(function () {
                    deferred.resolve();
                })['catch'](function (e) {
                    deferred.reject(e);
                });
            })['catch'](function (e) {
                deferred.reject(e);
            });
        } else {
            files.push(node);
            deferred.resolve();
        }
    } catch (e) {
        deferred.reject(e);
    }

    return deferred.promise;
};

module.exports = SftpConnection;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9zc3VuLy5hdG9tL3BhY2thZ2VzL3NmdHAtZGVwbG95bWVudC9saWIvY29ubmVjdGlvbnMvU2Z0cENvbm5lY3Rpb24uanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUlBLElBQUksT0FBTyxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUNsQyxJQUFJLElBQUksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDM0IsSUFBSSxJQUFJLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQzNCLElBQUksYUFBYSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQzs7QUFFcEMsSUFBSSxVQUFVLEdBQUcsT0FBTyxDQUFDLGNBQWMsQ0FBQyxDQUFDO0FBQ3pDLElBQUksU0FBUyxHQUFHLE9BQU8sQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO0FBQ3JELElBQUksSUFBSSxHQUFHLE9BQU8sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDOztBQUUzQyxJQUFJLG9CQUFvQixHQUFHLE9BQU8sQ0FBQyxzQ0FBc0MsQ0FBQyxDQUFDO0FBQzNFLElBQUksc0JBQXNCLEdBQUcsT0FBTyxDQUFDLHdDQUF3QyxDQUFDLENBQUM7QUFDL0UsSUFBSSxxQ0FBcUMsR0FBRyxPQUFPLENBQUMsdURBQXVELENBQUMsQ0FBQztBQUM3RyxJQUFJLHVCQUF1QixHQUFHLE9BQU8sQ0FBQyx5Q0FBeUMsQ0FBQyxDQUFDO0FBQ2pGLElBQUksbUNBQW1DLEdBQUcsT0FBTyxDQUFDLHFEQUFxRCxDQUFDLENBQUM7Ozs7OztBQU16RyxTQUFTLGNBQWMsQ0FBQyxNQUFNLEVBQUU7QUFDNUIsY0FBVSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDOztBQUVqQyxRQUFJLENBQUMsVUFBVSxHQUFHLElBQUksYUFBYSxFQUFFLENBQUM7Q0FDekM7O0FBRUQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxjQUFjLEVBQUUsVUFBVSxD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QUksS0FBSyxFQUFFO0FBQ2pCLHlCQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQztpQkFDekQ7O0FBRUQsdUJBQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQ2IsSUFBSSxDQUFDLFlBQVc7QUFDYiw0QkFBUSxDQUFDLE9BQU8sRUFBRSxDQUFDO2lCQUN0QixDQUFDLFNBQ0ksQ0FBQyxVQUFTLENBQUMsRUFBRTtBQUNmLDRCQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO2lCQUN0QixDQUFDLENBQUM7YUFDVixDQUFDLFNBQ0ksQ0FBQyxVQUFTLENBQUMsRUFBRTtBQUNmLHdCQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQ3RCLENBQUMsQ0FBQztTQUNWLE1BQU07QUFDSixpQkFBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUNqQixvQkFBUSxDQUFDLE9BQU8sRUFBRSxDQUFDO1NBQ3JCO0tBQ0osQ0FBQyxPQUFNLENBQUMsRUFBRTtBQUNQLGdCQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQ3RCOztBQUVELFdBQU8sUUFBUSxDQUFDLE9BQU8sQ0FBQztDQUMzQixDQUFBOztBQUVELE1BQU0sQ0FBQyxPQUFPLEdBQUcsY0FBYyxDQUFDIiwiZmlsZSI6Ii9Vc2Vycy9zc3VuLy5hdG9tL3BhY2thZ2VzL3NmdHAtZGVwbG95bWVudC9saWIvY29ubmVjdGlvbnMvU2Z0cENvbm5lY3Rpb24uanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLy8vLy8vLy8vLy8vLy8vLy9cbi8vIFJlcXVpcmVzXG4vLy8vLy8vLy8vLy8vLy8vLy9cblxudmFyIFByb21pc2UgPSByZXF1aXJlKCdibHVlYmlyZCcpO1xudmFyIHV0aWwgPSByZXF1aXJlKCd1dGlsJyk7XG52YXIgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbnZhciBTc2hDb25uZWN0aW9uID0gcmVxdWlyZSgnc3NoMicpO1xuXG52YXIgQ29ubmVjdGlvbiA9IHJlcXVpcmUoJy4vQ29ubmVjdGlvbicpO1xudmFyIERpcmVjdG9yeSA9IHJlcXVpcmUoJy4vLi4vZmlsZXN5c3RlbS9EaXJlY3RvcnknKTtcbnZhciBGaWxlID0gcmVxdWlyZSgnLi8uLi9maWxlc3lzdGVtL0ZpbGUnKTtcblxudmFyIFVwbG9hZEVycm9yRXhjZXB0aW9uID0gcmVxdWlyZSgnLi8uLi9leGNlcHRpb25zL1VwbG9hZEVycm9yRXhjZXB0aW9uJyk7XG52YXIgRG93bmxvYWRFcnJvckV4Y2VwdGlvbiA9IHJlcXVpcmUoJy4vLi4vZXhjZXB0aW9ucy9Eb3dubG9hZEVycm9yRXhjZXB0aW9uJyk7XG52YXIgUmVtb3RlRGlyZWN0b3J5Q3JlYXRpb25FcnJvckV4Y2VwdGlvbiA9IHJlcXVpcmUoJy4vLi4vZXhjZXB0aW9ucy9SZW1vdGVEaXJlY3RvcnlDcmVhdGlvbkVycm9yRXhjZXB0aW9uJyk7XG52YXIgVHJhbnNmZXJ0RXJyb3JFeGNlcHRpb24gPSByZXF1aXJlKCcuLy4uL2V4Y2VwdGlvbnMvVHJhbnNmZXJ0RXJyb3JFeGNlcHRpb24nKTtcbnZhciBSZW1vdGVEaXJlY3RvcnlOb3RSZWFkYWJsZUV4Y2VwdGlvbiA9IHJlcXVpcmUoJy4vLi4vZXhjZXB0aW9ucy9SZW1vdGVEaXJlY3RvcnlOb3RSZWFkYWJsZUV4Y2VwdGlvbicpO1xuXG4vLy8vLy8vLy8vLy8vLy8vLy9cbi8vIEN0b3Jcbi8vLy8vLy8vLy8vLy8vLy8vL1xuXG5mdW5jdGlvbiBTZnRwQ29ubmVjdGlvbihjb25maWcpIHtcbiAgICBDb25uZWN0aW9uLmFwcGx5KHRoaXMsIFtjb25maWddKTtcblxuICAgIHRoaXMuY29ubmVjdGlvbiA9IG5ldyBTc2hDb25uZWN0aW9uKCk7XG59XG5cbnV0aWwuaW5oZXJpdHMoU2Z0cENvbm5lY3Rpb24sIENvbm5lY3Rpb24pO1xuXG4vLy8vLy8vLy8vLy8vLy8vLy9cbi8vIE1ldGhvZHNcbi8vLy8vLy8vLy8vLy8vLy8vL1xuXG5TZnRwQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0Q29ubmVjdGlvbkluZm9ybWF0aW9ucyA9IGZ1bmN0aW9uKCkge1xuICAgIHZhciBzZWxmID0gdGhpcztcblxuICAgIHZhciBpbmZvcm1hdGlvbnMgPSB7XG4gICAgICAgIGhvc3Q6IHNlbGYuY29uZmlnLmhvc3QsXG4gICAgICAgIHBvcnQ6IHNlbGYuY29uZmlnLnBvcnQgPyBzZWxmLmNvbmZpZy5wb3J0IDogMjIsXG4gICAgICAgIHVzZXJuYW1lOiBzZWxmLmNvbmZpZy5nZXRVc2VybmFtZSgpXG4gICAgfVxuXG4gICAgaWYgKHNlbGYuY29uZmlnLmdldFBhc3N3b3JkKCkpIHtcbiAgICAgICAgaW5mb3JtYXRpb25zLnBhc3N3b3JkID0gc2VsZi5jb25maWcuZ2V0UGFzc3dvcmQoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBpbmZvcm1hdGlvbnMucHJpdmF0ZUtleSA9IHNlbGYuY29uZmlnLmdldFNzaEtleUZpbGUoKTtcbiAgICAgICAgaW5mb3JtYXRpb25zLnBhc3NwaHJhc2UgPSBzZWxmLmNvbmZpZy5nZXRQYXNzcGhyYXNlKCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGluZm9ybWF0aW9ucztcbn1cblxuU2Z0cENvbm5lY3Rpb24ucHJvdG90eXBlLmNyZWF0ZVJlbW90ZURpcmVjdG9yeSA9IGZ1bmN0aW9uKGRpcmVjdG9yeVBhdGgpIHtcbiAgICB2YXIgZGVmZXJyZWQgPSBQcm9taXNlLnBlbmRpbmcoKTtcblxuICAgIHRyeSB7XG4gICAgICAgIHZhciBzdWNjZXNzID0gdGhpcy5jb25uZWN0aW9uLmV4ZWMoXG4gICAgICAgICAgICAnbWtkaXIgLXAgJyArIGRpcmVjdG9yeVBhdGgsXG4gICAgICAgICAgICBmdW5jdGlvbiAoZXJyLCBzdHJlYW0pIHtcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdChuZXcgUmVtb3RlRGlyZWN0b3J5Q3JlYXRpb25FcnJvckV4Y2VwdGlvbihkaXJlY3RvcnlQYXRoKSk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgc3RyZWFtLm9uKCdjbG9zZScsIGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKGRpcmVjdG9yeVBhdGgpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIHN0cmVhbS5zdGRlcnIub24oJ2RhdGEnLCBmdW5jdGlvbihkYXRhKSB7XG4gICAgICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdChuZXcgUmVtb3RlRGlyZWN0b3J5Q3JlYXRpb25FcnJvckV4Y2VwdGlvbihkaXJlY3RvcnlQYXRoKSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICk7XG4gICAgfSBjYXRjaChlKSB7XG4gICAgICAgIGRlZmVycmVkLnJlamVjdChlKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZTtcbn1cblxuU2Z0cENvbm5lY3Rpb24ucHJvdG90eXBlLm9wZW5TZnRwID0gZnVuY3Rpb24oKSB7XG4gICAgdmFyIGRlZmVycmVkID0gUHJvbWlzZS5wZW5kaW5nKCk7XG5cbiAgICB0cnkge1xuICAgICAgICB0aGlzLmNvbm5lY3Rpb24uc2Z0cChmdW5jdGlvbihlcnIsIHNmdHApIHtcbiAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZWplY3QoZXJyKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShzZnRwKTtcbiAgICAgICAgfSk7XG4gICAgfSBjYXRjaChlKSB7XG4gICAgICAgIGRlZmVycmVkLnJlamVjdChlKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZTtcbn1cblxuU2Z0cENvbm5lY3Rpb24ucHJvdG90eXBlLmZhc3RQdXQgPSBmdW5jdGlvbihzZnRwLCBzb3VyY2VGaWxlLCBkZXN0aW5hdGlvbkZpbGUpIHtcbiAgICB2YXIgZGVmZXJyZWQgPSBQcm9taXNlLnBlbmRpbmcoKTtcblxuICAgIHRyeSB7XG4gICAgICAgIHNmdHAuZmFzdFB1dChzb3VyY2VGaWxlLCBkZXN0aW5hdGlvbkZpbGUsIGZ1bmN0aW9uKGVycikge1xuICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdChuZXcgVXBsb2FkRXJyb3JFeGNlcHRpb24oc291cmNlRmlsZSwgZXJyLm1lc3NhZ2UpKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShzZnRwKTtcbiAgICAgICAgfSk7XG4gICAgfSBjYXRjaChlKSB7XG4gICAgICAgIGRlZmVycmVkLnJlamVjdChlKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZTtcbn1cblxuU2Z0cENvbm5lY3Rpb24ucHJvdG90eXBlLmZhc3RHZXQgPSBmdW5jdGlvbihzZnRwLCBzb3VyY2VGaWxlLCBkZXN0aW5hdGlvbkZpbGUpIHtcbiAgICB2YXIgZGVmZXJyZWQgPSBQcm9taXNlLnBlbmRpbmcoKTtcblxuICAgIHRyeSB7XG4gICAgICAgIHNmdHAuZmFzdEdldChzb3VyY2VGaWxlLCBkZXN0aW5hdGlvbkZpbGUsIGZ1bmN0aW9uKGVycikge1xuICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgIGlmIChlcnIuY29kZSA9PT0gJ0VBQ0NFUycpIHtcbiAgICAgICAgICAgICAgICAgICAgZGVmZXJyZWQucmVqZWN0KG5ldyBEb3dubG9hZEVycm9yRXhjZXB0aW9uKGRlc3RpbmF0aW9uRmlsZSwgJ1Blcm1pc3Npb24gZGVuaWVkJykpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdChlcnIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShzZnRwKTtcbiAgICAgICAgfSk7XG4gICAgfSBjYXRjaChlKSB7XG4gICAgICAgIGRlZmVycmVkLnJlamVjdChlKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZTtcbn1cblxuU2Z0cENvbm5lY3Rpb24ucHJvdG90eXBlLnVwbG9hZEZpbGUgPSBmdW5jdGlvbihmaWxlKSB7XG4gICAgdmFyIGRlZmVycmVkID0gUHJvbWlzZS5wZW5kaW5nKCk7XG4gICAgdmFyIHNlbGYgPSB0aGlzO1xuICAgIHZhciBkZXN0aW5hdGlvbkZpbGUgPSBwYXRoLmpvaW4oXG4gICAgICAgIHRoaXMuY29uZmlnLmdldFJlbW90ZVBhdGgoKSxcbiAgICAgICAgZmlsZS5nZXRSZWxhdGl2ZVBhdGgoKVxuICAgICkucmVwbGFjZSgvXFxcXC9nLCAnLycpO1xuXG4gICAgdHJ5IHtcbiAgICAgICAgdGhpcy5jcmVhdGVSZW1vdGVEaXJlY3RvcnkocGF0aC5kaXJuYW1lKGRlc3RpbmF0aW9uRmlsZSkpXG4gICAgICAgICAgICAudGhlbihmdW5jdGlvbihkaXJlY3RvcnkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gc2VsZi5vcGVuU2Z0cCgpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKHNmdHApIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gc2VsZi5mYXN0UHV0KHNmdHAsIGZpbGUuZ2V0UGF0aCgpLCBkZXN0aW5hdGlvbkZpbGUpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKHNmdHApIHtcbiAgICAgICAgICAgICAgICBzZnRwLmVuZCgpO1xuICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUoZmlsZSk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZWplY3QoZSk7XG4gICAgICAgICAgICB9KTtcbiAgICB9IGNhdGNoKGUpIHtcbiAgICAgICAgZGVmZXJyZWQucmVqZWN0KGUpO1xuICAgIH1cblxuICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlO1xufVxuXG5TZnRwQ29ubmVjdGlvbi5wcm90b3R5cGUuZG93bmxvYWRGaWxlID0gZnVuY3Rpb24oZmlsZSkge1xuICAgIHZhciBkZWZlcnJlZCA9IFByb21pc2UucGVuZGluZygpO1xuICAgIHZhciBzZWxmID0gdGhpcztcbiAgICB2YXIgc291cmNlRmlsZSA9IHBhdGguam9pbihcbiAgICAgICAgdGhpcy5jb25maWcuZ2V0UmVtb3RlUGF0aCgpLFxuICAgICAgICBmaWxlLmdldFJlbGF0aXZlUGF0aCgpXG4gICAgKS5yZXBsYWNlKC9cXFxcL2csICcvJyk7XG5cbiAgICB0cnkge1xuICAgICAgICB0aGlzLmNyZWF0ZURpcmVjdG9yeShmaWxlLmdldERpcmVjdG9yeSgpKVxuICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24oZGlyZWN0b3J5KSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHNlbGYub3BlblNmdHAoKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAudGhlbihmdW5jdGlvbihzZnRwKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHNlbGYuZmFzdEdldChzZnRwLCBzb3VyY2VGaWxlLCBmaWxlLmdldFBhdGgoKSk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24oc2Z0cCkge1xuICAgICAgICAgICAgICAgIHNmdHAuZW5kKCk7XG4gICAgICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShmaWxlKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAuY2F0Y2goZnVuY3Rpb24oZSkge1xuICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdChlKTtcbiAgICAgICAgICAgIH0pO1xuICAgIH0gY2F0Y2goZSkge1xuICAgICAgICBkZWZlcnJlZC5yZWplY3QoZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7XG59XG5cblNmdHBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRMaXN0RGlyID0gZnVuY3Rpb24oc2Z0cCwgbm9kZSwgZmlsZXMpIHtcbiAgICB2YXIgZGVmZXJyZWQgPSBQcm9taXNlLnBlbmRpbmcoKTtcbiAgICB2YXIgc2VsZiA9IHRoaXM7XG5cbiAgICB0cnkge1xuICAgICAgICBpZiAobm9kZSBpbnN0YW5jZW9mIERpcmVjdG9yeSkge1xuICAgICAgICAgICAgdmFyIHJlbW90ZVBhdGggPSBwYXRoLmpvaW4oXG4gICAgICAgICAgICAgICAgdGhpcy5jb25maWcuZ2V0UmVtb3RlUGF0aCgpLFxuICAgICAgICAgICAgICAgIG5vZGUuZ2V0UmVsYXRpdmVQYXRoKClcbiAgICAgICAgICAgICkucmVwbGFjZSgvXFxcXC9nLCAnLycpO1xuXG4gICAgICAgICAgICBzZnRwLnJlYWRkaXIocmVtb3RlUGF0aCwgZnVuY3Rpb24oZXJyLCBub2Rlcykge1xuICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgZGVmZXJyZWQucmVqZWN0KG5ldyBSZW1vdGVEaXJlY3RvcnlOb3RSZWFkYWJsZUV4Y2VwdGlvbihyZW1vdGVQYXRoKSk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgdmFyIGNhbGxzID0gW107XG5cbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpIGluIG5vZGVzKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChub2Rlc1tpXS5hdHRycy5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjYWxscy5wdXNoKHNlbGYuZ2V0TGlzdERpcihzZnRwLCBuZXcgRGlyZWN0b3J5KHBhdGguam9pbihub2RlLmdldFJlbGF0aXZlUGF0aCgpLCBub2Rlc1tpXS5maWxlbmFtZSksIHRydWUpLCBmaWxlcykpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2FsbHMucHVzaChzZWxmLmdldExpc3REaXIoc2Z0cCwgbmV3IEZpbGUocGF0aC5qb2luKG5vZGUuZ2V0UmVsYXRpdmVQYXRoKCksIG5vZGVzW2ldLmZpbGVuYW1lKSwgdHJ1ZSksIGZpbGVzKSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBQcm9taXNlLmFsbChjYWxscylcbiAgICAgICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKCk7XG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgIC5jYXRjaChmdW5jdGlvbihlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZWplY3QoZSk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBmaWxlcy5wdXNoKG5vZGUpO1xuICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZSgpO1xuICAgICAgICB9XG4gICAgfSBjYXRjaChlKSB7XG4gICAgICAgIGRlZmVycmVkLnJlamVjdChlKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZTtcbn1cblxuU2Z0cENvbm5lY3Rpb24ucHJvdG90eXBlLmV4dHJhY3REaXN0YW50RmlsZXMgPSBmdW5jdGlvbihub2RlLCBmaWxlcykge1xuICAgIHZhciBkZWZlcnJlZCA9IFByb21pc2UucGVuZGluZygpO1xuICAgIHZhciBzZWxmID0gdGhpcztcblxuICAgIHRyeSB7XG4gICAgICAgIHZhciBzZnRwID0gbnVsbDtcbiAgICAgICAgaWYgKG5vZGUgaW5zdGFuY2VvZiBEaXJlY3RvcnkpIHtcbiAgICAgICAgICAgIHRoaXMub3BlblNmdHAoKVxuICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKF9zZnRwKSB7XG4gICAgICAgICAgICAgICAgICAgIHNmdHAgPSBfc2Z0cDtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlbGYuZ2V0TGlzdERpcihfc2Z0cCwgbm9kZSwgZmlsZXMpO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24obm9kZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgc2Z0cC5lbmQoKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGNhbGxzID0gW107XG5cbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSBpbiBub2Rlcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2FsbHMucHVzaCh0aGlzLmV4dHJhY3REaXN0YW50RmlsZXMobm9kZXNbaV0sIGZpbGVzKSk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBQcm9taXNlLmFsbChjYWxscylcbiAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICAuY2F0Y2goZnVuY3Rpb24oZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdChlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgZGVmZXJyZWQucmVqZWN0KGUpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICBmaWxlcy5wdXNoKG5vZGUpO1xuICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKCk7XG4gICAgICAgIH1cbiAgICB9IGNhdGNoKGUpIHtcbiAgICAgICAgZGVmZXJyZWQucmVqZWN0KGUpO1xuICAgIH1cblxuICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IFNmdHBDb25uZWN0aW9uO1xuIl19