{"mode":"editor","version":1,"windowDimensions":{"x":47,"y":23,"width":1235,"height":777,"maximized":true},"syntax":{"deserializer":"Syntax","grammarOverridesByPath":{}},"project":{"path":"/Users/ssun/Projects/tumblr/titanhose","buffers":[{"text":"package com.tumblr.data.titanhose\n\nimport backtype.storm.{Config, LocalCluster, StormSubmitter}\nimport backtype.storm.topology.TopologyBuilder\nimport backtype.storm.spout.SchemeAsMultiScheme\nimport backtype.storm.tuple.Fields\n\nimport storm.kafka.{KafkaSpout, SpoutConfig, ZkHosts}\n\nimport storm.starter.bolt.{RollingCountBolt, IntermediateRankingsBolt, TotalRankingsBolt}\n\ncase class PostAndAuthor(id: Long, user: String)\n\nobject Titanhose extends App {\n  val uniqueTopologyName = \"titanhose\"\n  val brokerDiscoveryZKHosts = new ZkHosts(\n    List(\"zk-07a08af2.ewr01.tumblr.net:2181\",\n         \"zk-1a488469.ewr01.tumblr.net:2181\",\n         \"zk-6fe10d0f.ewr01.tumblr.net:2181\",\n         \"zk-alpha-f67fcaf8.ewr01.tumblr.net:2181\",\n         \"zk-alpha-6043b096.ewr01.tumblr.net:2181/corvax\").mkString(\",\"))\n  val kafkaTopic = \"firehose-deduped-4\"\n  val spoutConfig = new SpoutConfig(brokerDiscoveryZKHosts,\n                                    kafkaTopic,\n                                    \"/fire\",\n                                    uniqueTopologyName)\n  val cassandraSeeds = \"172.17.164.6,172.17.164.7,172.17.164.8,172.17.164.9,172.17.164.10\"\n\n  spoutConfig.scheme = new SchemeAsMultiScheme(new FirehoseScheme())\n  spoutConfig.forceFromStart = true\n  val kafkaSpout = new KafkaSpout(spoutConfig)\n\n  val builder = new TopologyBuilder()\n  builder.setSpout(\"firehose_kafka_reader\", kafkaSpout, 3)\n  builder.setBolt(\"filter_bolt\", new FirehoseFilterBolt, 3).shuffleGrouping(\"firehose_kafka_reader\")\n  builder.setBolt(\"postGrapher\", new ReblogOutputBolt, 3).globalGrouping(\"filter_bolt\", \"posts\")\n  builder.setBolt(\"likeGrapher\", new LikeOutputBolt, 10).globalGrouping(\"filter_bolt\", \"likes\")\n  builder.setBolt(\"followGrapher\", new FollowOutputBolt(cassandraSeeds), 1).globalGrouping(\"filter_bolt\", \"follows\")\n\n  val conf = new Config()\n  conf.setDebug(false) // debug prints all tuples emitted, etc...\n\n  if (args.length > 0) {\n    conf.setNumWorkers(3)\n    conf.put(\"NIMBUS_HOST\", \"mm-vegemite-37b4f395\")\n    StormSubmitter.submitTopology(args(0), conf, builder.createTopology())\n  }\n  else {\n    val cluster = new LocalCluster()\n    cluster.submitTopology(uniqueTopologyName, conf, builder.createTopology())\n  }\n}\n","markers":{"markers":{"1":{"id":1,"range":[[38,0],[38,0]],"tailed":false,"reversed":false,"valid":true,"invalidate":"never","persistent":true,"properties":{"type":"selection","editorId":8,"goalBufferRange":null},"deserializer":"Marker"},"60":{"id":60,"range":[[29,0],[29,35]],"tailed":true,"reversed":false,"valid":true,"invalidate":"never","persistent":true,"properties":{},"deserializer":"Marker"},"508":{"id":508,"range":[[38,0],[38,0]],"tailed":true,"reversed":false,"valid":true,"invalidate":"overlap","persistent":true,"properties":{},"deserializer":"Marker"}},"deserializer":"MarkerManager"},"history":{"undoStack":[{"patches":[{"id":1,"oldParams":{"tailed":false},"newParams":{"tailed":true},"deserializer":"MarkerPatch"},{"id":1,"oldParams":{"reversed":false,"range":[[29,36],[29,36]]},"newParams":{"reversed":true,"range":[[29,35],[29,36]]},"deserializer":"MarkerPatch"},{"oldRange":[[29,35],[29,36]],"newRange":[[29,35],[29,35]],"oldText":"e","newText":"","normalizeLineEndings":true,"markerPatches":{},"deserializer":"BufferPatch"},{"id":1,"oldParams":{"tailed":true},"newParams":{"tailed":false},"deserializer":"MarkerPatch"},{"id":1,"oldParams":{"tailed":false},"newParams":{"tailed":true},"deserializer":"MarkerPatch"},{"id":1,"oldParams":{"range":[[29,35],[29,35]]},"newParams":{"range":[[29,34],[29,35]]},"deserializer":"MarkerPatch"},{"oldRange":[[29,34],[29,35]],"newRange":[[29,34],[29,34]],"oldText":"s","newText":"","normalizeLineEndings":true,"markerPatches":{},"deserializer":"BufferPatch"},{"id":1,"oldParams":{"tailed":true},"newParams":{"tailed":false},"deserializer":"MarkerPatch"},{"id":1,"oldParams":{"tailed":false},"newParams":{"tailed":true},"deserializer":"MarkerPatch"},{"id":1,"oldParams":{"range":[[29,34],[29,34]]},"newParams":{"range":[[29,33],[29,34]]},"deserializer":"MarkerPatch"},{"oldRange":[[29,33],[29,34]],"newRange":[[29,33],[29,33]],"oldText":"l","newText":"","normalizeLineEndings":true,"markerPatches":{},"deserializer":"BufferPatch"},{"id":1,"oldParams":{"tailed":true},"newParams":{"tailed":false},"deserializer":"MarkerPatch"},{"id":1,"oldParams":{"tailed":false},"newParams":{"tailed":true},"deserializer":"MarkerPatch"},{"id":1,"oldParams":{"range":[[29,33],[29,33]]},"newParams":{"range":[[29,32],[29,33]]},"deserializer":"MarkerPatch"},{"oldRange":[[29,32],[29,33]],"newRange":[[29,32],[29,32]],"oldText":"a","newText":"","normalizeLineEndings":true,"markerPatches":{},"deserializer":"BufferPatch"},{"id":1,"oldParams":{"tailed":true},"newParams":{"tailed":false},"deserializer":"MarkerPatch"},{"id":1,"oldParams":{"tailed":false},"newParams":{"tailed":true},"deserializer":"MarkerPatch"},{"id":1,"oldParams":{"range":[[29,32],[29,32]]},"newParams":{"range":[[29,31],[29,32]]},"deserializer":"MarkerPatch"},{"oldRange":[[29,31],[29,32]],"newRange":[[29,31],[29,31]],"oldText":"f","newText":"","normalizeLineEndings":true,"markerPatches":{},"deserializer":"BufferPatch"},{"id":1,"oldParams":{"tailed":true},"newParams":{"tailed":false},"deserializer":"MarkerPatch"},{"oldRange":[[29,31],[29,31]],"newRange":[[29,31],[29,32]],"oldText":"","newText":"t","normalizeLineEndings":{},"markerPatches":{},"deserializer":"BufferPatch"},{"oldRange":[[29,32],[29,32]],"newRange":[[29,32],[29,33]],"oldText":"","newText":"r","normalizeLineEndings":{},"markerPatches":{},"deserializer":"BufferPatch"},{"oldRange":[[29,33],[29,33]],"newRange":[[29,33],[29,34]],"oldText":"","newText":"u","normalizeLineEndings":{},"markerPatches":{},"deserializer":"BufferPatch"},{"oldRange":[[29,34],[29,34]],"newRange":[[29,34],[29,35]],"oldText":"","newText":"e","normalizeLineEndings":{},"markerPatches":{},"deserializer":"BufferPatch"},{"id":1,"oldParams":{"range":[[29,35],[29,35]]},"newParams":{"range":[[35,12],[35,12]]},"deserializer":"MarkerPatch"},{"id":1,"oldParams":{"range":[[35,12],[35,12]]},"newParams":{"range":[[42,13],[42,13]]},"deserializer":"MarkerPatch"},{"id":1,"oldParams":{"range":[[42,13],[42,13]]},"newParams":{"range":[[46,3],[46,3]]},"deserializer":"MarkerPatch"},{"id":1,"oldParams":{"range":[[46,3],[46,3]]},"newParams":{"range":[[33,13],[33,13]]},"deserializer":"MarkerPatch"},{"id":1,"oldParams":{"range":[[33,13],[33,13]]},"newParams":{"range":[[36,12],[36,12]]},"deserializer":"MarkerPatch"},{"id":1,"oldParams":{"range":[[36,12],[36,12]]},"newParams":{"range":[[36,36],[36,36]]},"deserializer":"MarkerPatch"},{"id":1,"oldParams":{"range":[[36,36],[36,36]]},"newParams":{"range":[[36,44],[36,44]]},"deserializer":"MarkerPatch"},{"id":1,"oldParams":{"tailed":false},"newParams":{"tailed":true},"deserializer":"MarkerPatch"},{"id":1,"oldParams":{"reversed":true,"range":[[36,44],[36,44]]},"newParams":{"reversed":false,"range":[[36,37],[36,51]]},"deserializer":"MarkerPatch"},{"id":1,"oldParams":{"tailed":true,"range":[[36,37],[36,51]]},"newParams":{"tailed":false,"range":[[36,51],[36,51]]},"deserializer":"MarkerPatch"},{"id":1,"oldParams":{"range":[[36,51],[36,51]]},"newParams":{"range":[[37,44],[37,44]]},"deserializer":"MarkerPatch"},{"id":1,"oldParams":{"tailed":false},"newParams":{"tailed":true},"deserializer":"MarkerPatch"},{"id":1,"oldParams":{"range":[[37,44],[37,44]]},"newParams":{"range":[[37,39],[37,55]]},"deserializer":"MarkerPatch"},{"id":1,"oldParams":{"tailed":true,"range":[[37,39],[37,55]]},"newParams":{"tailed":false,"range":[[37,55],[37,55]]},"deserializer":"MarkerPatch"},{"id":1,"oldParams":{"range":[[37,55],[37,55]]},"newParams":{"range":[[38,0],[38,0]]},"deserializer":"MarkerPatch"},{"id":1,"oldParams":{"range":[[38,0],[38,0]]},"newParams":{"range":[[15,19],[15,19]]},"deserializer":"MarkerPatch"},{"id":1,"oldParams":{"tailed":false},"newParams":{"tailed":true},"deserializer":"MarkerPatch"},{"id":1,"oldParams":{"range":[[15,19],[15,19]]},"newParams":{"range":[[15,6],[15,28]]},"deserializer":"MarkerPatch"}],"deserializer":"Transaction"}],"redoStack":[],"deserializer":"History"},"encoding":"utf8","filePath":"/Users/ssun/Projects/tumblr/titanhose/src/main/scala/com/tumblr/data/titanhose/Titanhose.scala","modifiedWhenLastPersisted":false,"digestWhenLastPersisted":"078106df9622c5e2bf6b84d5cbbd9b420e9b8582","deserializer":"TextBuffer"},{"text":"package com.tumblr.data.titanhose\n\nimport scala.collection.JavaConversions._\n\nimport backtype.storm.topology.base.BaseBasicBolt\nimport backtype.storm.topology.{BasicOutputCollector, OutputFieldsDeclarer}\nimport backtype.storm.tuple.{Fields, Tuple}\n\nimport com.tinkerpop.blueprints.Vertex\nimport com.thinkaurelius.titan.core.TitanFactory\nimport org.apache.commons.configuration.BaseConfiguration\n\nimport com.tumblr.firehose.api.objects._\n\n\nclass FollowOutputBolt(seeds: String) extends BaseBasicBolt {\n  lazy val conf = {\n    val c = new BaseConfiguration()\n    c.setProperty(\"storage.backend\",\"cassandra\")\n    c.setProperty(\"storage.hostname\", seeds)\n    c\n  }\n  lazy val titan = {\n    val g = TitanFactory.open(conf)\n    g.createKeyIndex(\"blog_id\",classOf[Vertex])\n    //g.makeLabel(\"follows\").make()\n    g.commit()\n    g\n  }\n\n  override def execute(tuple: Tuple, collector: BasicOutputCollector) = {\n    val activity = tuple.getValue(0).asInstanceOf[Envelope].activity.asInstanceOf[ActivityFollow]\n    val follower = getOrCreateVertex(activity.userPrimaryBlogId)\n    val followed = getOrCreateVertex(activity.followedBlog.id)\n    follower.addEdge(\"follows\", follower)\n    titan.commit()\n  }\n\n  def getOrCreateVertex(key: Long): Vertex = {\n    var vertex = titan.getVertex(key)\n    if (vertex == null) {\n      vertex = titan.addVertex(null)\n      vertex.setProperty(\"blog_id\", key)\n      println(\"created vertex for %d\" format key)\n    }\n    vertex\n  }\n\n  override def declareOutputFields(declarer: OutputFieldsDeclarer) =\n    declarer.declare(new Fields())\n}\n","markers":{"markers":{"1":{"id":1,"range":[[23,35],[23,35]],"tailed":false,"reversed":false,"valid":true,"invalidate":"never","persistent":true,"properties":{"type":"selection","editorId":12,"goalBufferRange":null},"deserializer":"Marker"},"28":{"id":28,"range":[[25,0],[25,35]],"tailed":true,"reversed":false,"valid":true,"invalidate":"never","persistent":true,"properties":{},"deserializer":"Marker"}},"deserializer":"MarkerManager"},"history":{"undoStack":[{"patches":[{"oldRange":[[25,4],[25,4]],"newRange":[[25,4],[25,6]],"oldText":"","newText":"//","normalizeLineEndings":true,"markerPatches":{},"deserializer":"BufferPatch"}],"deserializer":"Transaction"}],"redoStack":[],"deserializer":"History"},"encoding":"utf8","filePath":"/Users/ssun/Projects/tumblr/titanhose/src/main/scala/com/tumblr/data/titanhose/FollowOutputBolt.scala","modifiedWhenLastPersisted":false,"digestWhenLastPersisted":"7a21efbf24a1a620afa86b10d5972094f9ce59c8","deserializer":"TextBuffer"}],"deserializer":"Project"},"workspace":{"paneContainer":{"root":{"id":3,"items":[{"id":8,"softTabs":true,"displayBuffer":{"id":9,"softWrapped":false,"editorWidthInChars":null,"scrollTop":155,"scrollLeft":0,"tokenizedBuffer":{"bufferPath":"/Users/ssun/Projects/tumblr/titanhose/src/main/scala/com/tumblr/data/titanhose/Titanhose.scala","invisibles":null,"deserializer":"TokenizedBuffer"},"invisibles":null,"deserializer":"DisplayBuffer"},"deserializer":"TextEditor"},{"id":12,"softTabs":true,"displayBuffer":{"id":13,"softWrapped":false,"editorWidthInChars":null,"scrollTop":27,"scrollLeft":0,"tokenizedBuffer":{"bufferPath":"/Users/ssun/Projects/tumblr/titanhose/src/main/scala/com/tumblr/data/titanhose/FollowOutputBolt.scala","invisibles":null,"deserializer":"TokenizedBuffer"},"invisibles":null,"deserializer":"DisplayBuffer"},"deserializer":"TextEditor"}],"activeItemUri":"/Users/ssun/Projects/tumblr/titanhose/src/main/scala/com/tumblr/data/titanhose/Titanhose.scala","focused":false,"deserializer":"Pane"},"activePaneId":3,"deserializer":"PaneContainer","version":1},"fullScreen":false,"packagesWithActiveGrammars":["language-scala","language-hyperlink","language-todo"],"deserializer":"Workspace"},"packageStates":{"sublime-tabs":{"directoryExpansionStates":{"project":{},"src":{"main":{"scala":{"com":{"tumblr":{"data":{"titanhose":{}}}}}}}},"selectedPath":"/Users/ssun/Projects/tumblr/titanhose/src/main/scala/com/tumblr/data/titanhose/Titanhose.scala","hasFocus":false,"attached":true,"scrollLeft":114,"scrollTop":0,"width":199},"fuzzy-finder":{"/Users/ssun/Projects/tumblr/titanhose/src/main/scala/com/tumblr/data/titanhose/Titanhose.scala":1415295591619,"/Users/ssun/Projects/tumblr/titanhose/src/main/scala/com/tumblr/data/titanhose/FollowOutputBolt.scala":1415295525559},"keybinding-resolver":{"attached":false},"metrics":{"sessionLength":350562770}}}