//////////////////
// Requires
//////////////////

var fs = require('fs');
var path = require('path');
var util = require('util');

var ConfigFactory = require('./configs/ConfigFactory');
var ConnectionFactory = require('./connections/ConnectionFactory');
var Connection = require('./connections/Connection');
var oFileManager = require('./filesystem/FileManager');

var OperationalError = require('bluebird').Promise.OperationalError;
var NoConfigurationFileFoundException = require('./exceptions/NoConfigurationFileFoundException');
var ConfigurationFileNotReadableException = require('./exceptions/ConfigurationFileNotReadableException');
var ConfigurationFileSyntaxErrorException = require('./exceptions/ConfigurationFileSyntaxErrorException');
var ConnectionErrorException = require('./exceptions/ConnectionErrorException');
var UploadErrorException = require('./exceptions/UploadErrorException');
var DownloadErrorException = require('./exceptions/DownloadErrorException');
var RemoteDirectoryCreationErrorException = require('./exceptions/RemoteDirectoryCreationErrorException');
var DirectoryCreationErrorException = require('./exceptions/DirectoryCreationErrorException');
var TransfertErrorException = require('./exceptions/TransfertErrorException');
var RemoteDirectoryNotReadableException = require('./exceptions/RemoteDirectoryNotReadableException');

var self;

//////////////////
// Ctor
//////////////////

function DeploymentManager() {
    this.observers = [];
    this.configurationFileName = 'deployment-config.json';

    self = this;
}

//////////////////
// Methods
//////////////////

DeploymentManager.prototype.registerObserver = function (observer) {
    this.observers.push(observer);
};

DeploymentManager.prototype.notifyObservers = function (value, data) {
    this.observers.forEach(function (observer) {
        observer.notify(value, data);
    });
};

DeploymentManager.prototype.upload = function (files) {
    var configFactory = new ConfigFactory();
    var connectionFactory = new ConnectionFactory();
    var configPath = path.join(atom.project.rootDirectories[0].path, self.configurationFileName);

    return configFactory.loadConfig(configPath).then(function (config) {
        return connectionFactory.openConnection(config);
    }).then(function (connection) {
        return connection.upload(files);
    }).then(function (connection) {
        return connection.close();
    }).then(function (success) {
        if (success) {
            self.notifyObservers('upload_file_success');
            return;
        }
        self.notifyObservers('upload_file_error');
    })['catch'](NoConfigurationFileFoundException, function (e) {
        self.notifyObservers('no_configuration_file_found');
    })['catch'](ConfigurationFileNotReadableException, function (e) {
        self.notifyObservers('configuration_file_not_readable');
    })['catch'](ConfigurationFileSyntaxErrorException, function (e) {
        self.notifyObservers('configuration_file_syntax_error', e);
    })['catch'](ConnectionErrorException, function (e) {
        self.notifyObservers('connection_error', e);
    })['catch'](UploadErrorException, function (e) {
        self.notifyObservers('upload_file_error', e);
    })['catch'](RemoteDirectoryCreationErrorException, function (e) {
        self.notifyObservers('remote_directory_creation_error', e);
    })['catch'](TransfertErrorException, function (e) {
        self.notifyObservers('transfert_file_error', e);
    })['catch'](function (e) {
        console.error(e);
    });
};

DeploymentManager.prototype.download = function (nodes) {
    var configFactory = new ConfigFactory();
    var connectionFactory = new ConnectionFactory();
    var configPath = path.join(atom.project.rootDirectories[0].path, self.configurationFileName);
    var conn = null;

    return configFactory.loadConfig(configPath).then(function (config) {
        return connectionFactory.openConnection(config);
    }).then(function (connection) {
        conn = connection;
        return connection.getTargetFiles(nodes);
    }).then(function (files) {
        return conn.download(files);
    }).then(function (connection) {
        return connection.close();
    }).then(function (success) {
        if (success) {
            self.notifyObservers('download_file_success');
            return;
        }
        self.notifyObservers('download_file_error');
    })['catch'](NoConfigurationFileFoundException, function (e) {
        self.notifyObservers('no_configuration_file_found');
    })['catch'](ConfigurationFileNotReadableException, function (e) {
        self.notifyObservers('configuration_file_not_readable');
    })['catch'](ConfigurationFileSyntaxErrorException, function (e) {
        self.notifyObservers('configuration_file_syntax_error', e);
    })['catch'](ConnectionErrorException, function (e) {
        self.notifyObservers('connection_error', e);
    })['catch'](DownloadErrorException, function (e) {
        self.notifyObservers('download_file_error', e);
    })['catch'](DirectoryCreationErrorException, function (e) {
        self.notifyObservers('directory_creation_error', e);
    })['catch'](TransfertErrorException, function (e) {
        self.notifyObservers('transfert_file_error', e);
    })['catch'](RemoteDirectoryNotReadableException, function (e) {
        self.notifyObservers('remote_directory_not_readable', e);
    })['catch'](function (e) {
        console.error(e);
    });
};

/**
 * Generate a default configuration file
 * Ask which protocol the user want to use
 */
DeploymentManager.prototype.generateConfigFile = function () {
    var configFactory = new ConfigFactory();

    if (atom.project.rootDirectories.length < 1) {
        self.notifyObservers('project_not_found');
        return;
    }

    var configPath = path.join(atom.project.rootDirectories[0].path, self.configurationFileName);

    atom.confirm({
        message: 'Which type of configuration you want to generate ?',
        detailedMessage: 'Be careful, this will overwrite the existent configuration file !',
        buttons: {
            SFTP: function SFTP() {
                configFactory.createSftpConfig().save(configPath).then(function () {
                    self.notifyObservers('configuration_file_creation_success');
                })['catch'](function (e) {
                    self.notifyObservers('configuration_file_creation_error', e);
                });
            },
            FTP: function FTP() {
                configFactory.createFtpConfig().save(configPath).then(function () {
                    self.notifyObservers('configuration_file_creation_success');
                })['catch'](function (e) {
                    self.notifyObservers('configuration_file_creation_error', e);
                });
            },
            Cancel: null
        }
    });
};

/**
 * Upload the open tab file
 */
DeploymentManager.prototype.uploadCurrentFile = function () {
    self.notifyObservers('begin_transfert');
    oFileManager.getCurrentFile().then(function (file) {
        self.upload([file]);
    });
};

/**
 * Upload on save
 */
DeploymentManager.prototype.uploadOnSave = function () {
    var configFactory = new ConfigFactory();
    var configPath = path.join(atom.project.rootDirectories[0].path, self.configurationFileName);

    configFactory.loadConfig(configPath).then(function (config) {
        if (config.getUploadOnSave()) {
            return self.uploadCurrentFile();
        }
    });
};

/**
 * Download the open tab file
 */
DeploymentManager.prototype.downloadCurrentFile = function () {
    atom.confirm({
        message: 'You will download the current file, be careful, it will be overwritten.',
        buttons: {
            Overwrite: function Overwrite() {
                self.notifyObservers('begin_transfert');
                oFileManager.getCurrentFile().then(function (file) {
                    self.download([file]);
                });
            },
            Cancel: null
        }
    });
};

/**
 * Upload open tab files
 */
DeploymentManager.prototype.uploadOpenFiles = function () {
    self.notifyObservers('begin_transfert');
    oFileManager.getOpenFiles().then(function (files) {
        self.upload(files);
    });
};

/**
 * Upload a tree-view selection
 */
DeploymentManager.prototype.uploadSelection = function () {
    self.notifyObservers('begin_transfert');
    oFileManager.getSelection(true).then(function (files) {
        self.upload(files);
    });
};

/**
 * Download a tree-view selection
 */
DeploymentManager.prototype.downloadSelection = function () {
    atom.confirm({
        message: 'You will download all your selection, be careful, it will be overwritted.',
        buttons: {
            Overwrite: function Overwrite() {
                self.notifyObservers('begin_transfert');
                oFileManager.getSelection().then(function (nodes) {
                    self.download(nodes);
                });
            },
            Cancel: null
        }
    });
};

module.exports = DeploymentManager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9zc3VuLy5hdG9tL3BhY2thZ2VzL3NmdHAtZGVwbG95bWVudC9saWIvRGVwbG95bWVudE1hbmFnZXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUlBLElBQUksRUFBRSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUN2QixJQUFJLElBQUksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDM0IsSUFBSSxJQUFJLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDOztBQUUzQixJQUFJLGFBQWEsR0FBRyxPQUFPLENBQUMseUJBQXlCLENBQUMsQ0FBQztBQUN2RCxJQUFJLGlCQUFpQixHQUFHLE9BQU8sQ0FBQyxpQ0FBaUMsQ0FBQyxDQUFDO0FBQ25FLElBQUksVUFBVSxHQUFHLE9BQU8sQ0FBQywwQkFBMEIsQ0FBQyxDQUFDO0FBQ3JELElBQUksWUFBWSxHQUFHLE9BQU8sQ0FBQywwQkFBMEIsQ0FBQyxDQUFDOztBQUV2RCxJQUFJLGdCQUFnQixHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLENBQUM7QUFDcEUsSUFBSSxpQ0FBaUMsR0FBRyxPQUFPLENBQUMsZ0RBQWdELENBQUMsQ0FBQztBQUNsRyxJQUFJLHFDQUFxQyxHQUFHLE9BQU8sQ0FBQyxvREFBb0QsQ0FBQyxDQUFDO0FBQzFHLElBQUkscUNBQXFDLEdBQUcsT0FBTyxDQUFDLG9EQUFvRCxDQUFDLENBQUM7QUFDMUcsSUFBSSx3QkFBd0IsR0FBRyxPQUFPLENBQUMsdUNBQXVDLENBQUMsQ0FBQztBQUNoRixJQUFJLG9CQUFvQixHQUFHLE9BQU8sQ0FBQyxtQ0FBbUMsQ0FBQyxDQUFDO0FBQ3hFLElBQUksc0JBQXNCLEdBQUcsT0FBTyxDQUFDLHFDQUFxQyxDQUFDLENBQUM7QUFDNUUsSUFBSSxxQ0FBcUMsR0FBRyxPQUFPLENBQUMsb0RBQW9ELENBQUMsQ0FBQztBQUMxRyxJQUFJLCtCQUErQixHQUFHLE9B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MkVBQTJFO0FBQ3BGLGVBQU8sRUFBRTtBQUNMLHVCQUFhLHFCQUFZO0FBQ3JCLG9CQUFJLENBQUMsZUFBZSxDQUFDLGlCQUFpQixDQUFDLENBQUM7QUFDeEMsNEJBQVksQ0FBQyxZQUFZLEVBQUUsQ0FDdEIsSUFBSSxDQUFDLFVBQVMsS0FBSyxFQUFFO0FBQ2xCLHdCQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDO2lCQUN4QixDQUFDLENBQUM7YUFDVjtBQUNILG9CQUFVLElBQUk7U0FDZjtLQUNKLENBQUMsQ0FBQztDQUNOLENBQUM7O0FBRUYsTUFBTSxDQUFDLE9BQU8sR0FBRyxpQkFBaUIsQ0FBQyIsImZpbGUiOiIvVXNlcnMvc3N1bi8uYXRvbS9wYWNrYWdlcy9zZnRwLWRlcGxveW1lbnQvbGliL0RlcGxveW1lbnRNYW5hZ2VyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8vLy8vLy8vLy8vLy8vLy8vXG4vLyBSZXF1aXJlc1xuLy8vLy8vLy8vLy8vLy8vLy8vXG5cbnZhciBmcyA9IHJlcXVpcmUoJ2ZzJyk7XG52YXIgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbnZhciB1dGlsID0gcmVxdWlyZSgndXRpbCcpO1xuXG52YXIgQ29uZmlnRmFjdG9yeSA9IHJlcXVpcmUoJy4vY29uZmlncy9Db25maWdGYWN0b3J5Jyk7XG52YXIgQ29ubmVjdGlvbkZhY3RvcnkgPSByZXF1aXJlKCcuL2Nvbm5lY3Rpb25zL0Nvbm5lY3Rpb25GYWN0b3J5Jyk7XG52YXIgQ29ubmVjdGlvbiA9IHJlcXVpcmUoJy4vY29ubmVjdGlvbnMvQ29ubmVjdGlvbicpO1xudmFyIG9GaWxlTWFuYWdlciA9IHJlcXVpcmUoJy4vZmlsZXN5c3RlbS9GaWxlTWFuYWdlcicpO1xuXG52YXIgT3BlcmF0aW9uYWxFcnJvciA9IHJlcXVpcmUoJ2JsdWViaXJkJykuUHJvbWlzZS5PcGVyYXRpb25hbEVycm9yO1xudmFyIE5vQ29uZmlndXJhdGlvbkZpbGVGb3VuZEV4Y2VwdGlvbiA9IHJlcXVpcmUoJy4vZXhjZXB0aW9ucy9Ob0NvbmZpZ3VyYXRpb25GaWxlRm91bmRFeGNlcHRpb24nKTtcbnZhciBDb25maWd1cmF0aW9uRmlsZU5vdFJlYWRhYmxlRXhjZXB0aW9uID0gcmVxdWlyZSgnLi9leGNlcHRpb25zL0NvbmZpZ3VyYXRpb25GaWxlTm90UmVhZGFibGVFeGNlcHRpb24nKTtcbnZhciBDb25maWd1cmF0aW9uRmlsZVN5bnRheEVycm9yRXhjZXB0aW9uID0gcmVxdWlyZSgnLi9leGNlcHRpb25zL0NvbmZpZ3VyYXRpb25GaWxlU3ludGF4RXJyb3JFeGNlcHRpb24nKTtcbnZhciBDb25uZWN0aW9uRXJyb3JFeGNlcHRpb24gPSByZXF1aXJlKCcuL2V4Y2VwdGlvbnMvQ29ubmVjdGlvbkVycm9yRXhjZXB0aW9uJyk7XG52YXIgVXBsb2FkRXJyb3JFeGNlcHRpb24gPSByZXF1aXJlKCcuL2V4Y2VwdGlvbnMvVXBsb2FkRXJyb3JFeGNlcHRpb24nKTtcbnZhciBEb3dubG9hZEVycm9yRXhjZXB0aW9uID0gcmVxdWlyZSgnLi9leGNlcHRpb25zL0Rvd25sb2FkRXJyb3JFeGNlcHRpb24nKTtcbnZhciBSZW1vdGVEaXJlY3RvcnlDcmVhdGlvbkVycm9yRXhjZXB0aW9uID0gcmVxdWlyZSgnLi9leGNlcHRpb25zL1JlbW90ZURpcmVjdG9yeUNyZWF0aW9uRXJyb3JFeGNlcHRpb24nKTtcbnZhciBEaXJlY3RvcnlDcmVhdGlvbkVycm9yRXhjZXB0aW9uID0gcmVxdWlyZSgnLi9leGNlcHRpb25zL0RpcmVjdG9yeUNyZWF0aW9uRXJyb3JFeGNlcHRpb24nKTtcbnZhciBUcmFuc2ZlcnRFcnJvckV4Y2VwdGlvbiA9IHJlcXVpcmUoJy4vZXhjZXB0aW9ucy9UcmFuc2ZlcnRFcnJvckV4Y2VwdGlvbicpO1xudmFyIFJlbW90ZURpcmVjdG9yeU5vdFJlYWRhYmxlRXhjZXB0aW9uID0gcmVxdWlyZSgnLi9leGNlcHRpb25zL1JlbW90ZURpcmVjdG9yeU5vdFJlYWRhYmxlRXhjZXB0aW9uJyk7XG5cbnZhciBzZWxmO1xuXG4vLy8vLy8vLy8vLy8vLy8vLy9cbi8vIEN0b3Jcbi8vLy8vLy8vLy8vLy8vLy8vL1xuXG5mdW5jdGlvbiBEZXBsb3ltZW50TWFuYWdlcigpIHtcbiAgICB0aGlzLm9ic2VydmVycyA9IFtdO1xuICAgIHRoaXMuY29uZmlndXJhdGlvbkZpbGVOYW1lID0gXCJkZXBsb3ltZW50LWNvbmZpZy5qc29uXCI7XG5cbiAgICBzZWxmID0gdGhpcztcbn1cblxuLy8vLy8vLy8vLy8vLy8vLy8vXG4vLyBNZXRob2RzXG4vLy8vLy8vLy8vLy8vLy8vLy9cblxuRGVwbG95bWVudE1hbmFnZXIucHJvdG90eXBlLnJlZ2lzdGVyT2JzZXJ2ZXIgPSBmdW5jdGlvbihvYnNlcnZlcikge1xuICAgIHRoaXMub2JzZXJ2ZXJzLnB1c2gob2JzZXJ2ZXIpO1xufTtcblxuRGVwbG95bWVudE1hbmFnZXIucHJvdG90eXBlLm5vdGlmeU9ic2VydmVycyA9IGZ1bmN0aW9uKHZhbHVlLCBkYXRhKSB7XG4gICAgdGhpcy5vYnNlcnZlcnMuZm9yRWFjaChmdW5jdGlvbiAob2JzZXJ2ZXIpIHtcbiAgICAgICAgb2JzZXJ2ZXIubm90aWZ5KHZhbHVlLCBkYXRhKTtcbiAgICB9KTtcbn07XG5cbkRlcGxveW1lbnRNYW5hZ2VyLnByb3RvdHlwZS51cGxvYWQgPSBmdW5jdGlvbihmaWxlcykge1xuICAgIHZhciBjb25maWdGYWN0b3J5ID0gbmV3IENvbmZpZ0ZhY3RvcnkoKTtcbiAgICB2YXIgY29ubmVjdGlvbkZhY3RvcnkgPSBuZXcgQ29ubmVjdGlvbkZhY3RvcnkoKTtcbiAgICB2YXIgY29uZmlnUGF0aCA9IHBhdGguam9pbihcbiAgICAgICAgYXRvbS5wcm9qZWN0LnJvb3REaXJlY3Rvcmllc1swXS5wYXRoLFxuICAgICAgICBzZWxmLmNvbmZpZ3VyYXRpb25GaWxlTmFtZVxuICAgICk7XG5cbiAgICByZXR1cm4gY29uZmlnRmFjdG9yeS5sb2FkQ29uZmlnKGNvbmZpZ1BhdGgpXG4gICAgICAgIC50aGVuKGZ1bmN0aW9uKGNvbmZpZykge1xuICAgICAgICAgICAgcmV0dXJuIGNvbm5lY3Rpb25GYWN0b3J5Lm9wZW5Db25uZWN0aW9uKGNvbmZpZyk7XG4gICAgICAgIH0pXG4gICAgICAgIC50aGVuKGZ1bmN0aW9uKGNvbm5lY3Rpb24pIHtcbiAgICAgICAgICAgIHJldHVybiBjb25uZWN0aW9uLnVwbG9hZChmaWxlcyk7XG4gICAgICAgIH0pXG4gICAgICAgIC50aGVuKGZ1bmN0aW9uKGNvbm5lY3Rpb24pIHtcbiAgICAgICAgICAgIHJldHVybiBjb25uZWN0aW9uLmNsb3NlKCk7XG4gICAgICAgIH0pXG4gICAgICAgIC50aGVuKGZ1bmN0aW9uKHN1Y2Nlc3MpIHtcbiAgICAgICAgICAgIGlmIChzdWNjZXNzKSB7XG4gICAgICAgICAgICAgICAgc2VsZi5ub3RpZnlPYnNlcnZlcnMoJ3VwbG9hZF9maWxlX3N1Y2Nlc3MnKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzZWxmLm5vdGlmeU9ic2VydmVycygndXBsb2FkX2ZpbGVfZXJyb3InKTtcbiAgICAgICAgfSlcbiAgICAgICAgLmNhdGNoKE5vQ29uZmlndXJhdGlvbkZpbGVGb3VuZEV4Y2VwdGlvbiwgZnVuY3Rpb24oZSkge1xuICAgICAgICAgICAgc2VsZi5ub3RpZnlPYnNlcnZlcnMoJ25vX2NvbmZpZ3VyYXRpb25fZmlsZV9mb3VuZCcpO1xuICAgICAgICB9KVxuICAgICAgICAuY2F0Y2goQ29uZmlndXJhdGlvbkZpbGVOb3RSZWFkYWJsZUV4Y2VwdGlvbiwgZnVuY3Rpb24oZSkge1xuICAgICAgICAgICAgc2VsZi5ub3RpZnlPYnNlcnZlcnMoJ2NvbmZpZ3VyYXRpb25fZmlsZV9ub3RfcmVhZGFibGUnKTtcbiAgICAgICAgfSlcbiAgICAgICAgLmNhdGNoKENvbmZpZ3VyYXRpb25GaWxlU3ludGF4RXJyb3JFeGNlcHRpb24sIGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICAgIHNlbGYubm90aWZ5T2JzZXJ2ZXJzKCdjb25maWd1cmF0aW9uX2ZpbGVfc3ludGF4X2Vycm9yJywgZSk7XG4gICAgICAgIH0pXG4gICAgICAgIC5jYXRjaChDb25uZWN0aW9uRXJyb3JFeGNlcHRpb24sIGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICAgIHNlbGYubm90aWZ5T2JzZXJ2ZXJzKCdjb25uZWN0aW9uX2Vycm9yJywgZSk7XG4gICAgICAgIH0pXG4gICAgICAgIC5jYXRjaChVcGxvYWRFcnJvckV4Y2VwdGlvbiwgZnVuY3Rpb24oZSkge1xuICAgICAgICAgICAgc2VsZi5ub3RpZnlPYnNlcnZlcnMoJ3VwbG9hZF9maWxlX2Vycm9yJywgZSk7XG4gICAgICAgIH0pXG4gICAgICAgIC5jYXRjaChSZW1vdGVEaXJlY3RvcnlDcmVhdGlvbkVycm9yRXhjZXB0aW9uLCBmdW5jdGlvbihlKSB7XG4gICAgICAgICAgICBzZWxmLm5vdGlmeU9ic2VydmVycygncmVtb3RlX2RpcmVjdG9yeV9jcmVhdGlvbl9lcnJvcicsIGUpO1xuICAgICAgICB9KVxuICAgICAgICAuY2F0Y2goVHJhbnNmZXJ0RXJyb3JFeGNlcHRpb24sIGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICAgIHNlbGYubm90aWZ5T2JzZXJ2ZXJzKCd0cmFuc2ZlcnRfZmlsZV9lcnJvcicsIGUpO1xuICAgICAgICB9KVxuICAgICAgICAuY2F0Y2goZnVuY3Rpb24oZSkge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihlKTtcbiAgICAgICAgfSk7XG59O1xuXG5EZXBsb3ltZW50TWFuYWdlci5wcm90b3R5cGUuZG93bmxvYWQgPSBmdW5jdGlvbihub2Rlcykge1xuICAgIHZhciBjb25maWdGYWN0b3J5ID0gbmV3IENvbmZpZ0ZhY3RvcnkoKTtcbiAgICB2YXIgY29ubmVjdGlvbkZhY3RvcnkgPSBuZXcgQ29ubmVjdGlvbkZhY3RvcnkoKTtcbiAgICB2YXIgY29uZmlnUGF0aCA9IHBhdGguam9pbihcbiAgICAgICAgYXRvbS5wcm9qZWN0LnJvb3REaXJlY3Rvcmllc1swXS5wYXRoLFxuICAgICAgICBzZWxmLmNvbmZpZ3VyYXRpb25GaWxlTmFtZVxuICAgICk7XG4gICAgdmFyIGNvbm4gPSBudWxsO1xuXG4gICAgcmV0dXJuIGNvbmZpZ0ZhY3RvcnkubG9hZENvbmZpZyhjb25maWdQYXRoKVxuICAgICAgICAudGhlbihmdW5jdGlvbihjb25maWcpIHtcbiAgICAgICAgICAgIHJldHVybiBjb25uZWN0aW9uRmFjdG9yeS5vcGVuQ29ubmVjdGlvbihjb25maWcpO1xuICAgICAgICB9KVxuICAgICAgICAudGhlbihmdW5jdGlvbihjb25uZWN0aW9uKSB7XG4gICAgICAgICAgICBjb25uID0gY29ubmVjdGlvbjtcbiAgICAgICAgICAgIHJldHVybiBjb25uZWN0aW9uLmdldFRhcmdldEZpbGVzKG5vZGVzKTtcbiAgICAgICAgfSlcbiAgICAgICAgLnRoZW4oZnVuY3Rpb24oZmlsZXMpIHtcbiAgICAgICAgICAgIHJldHVybiBjb25uLmRvd25sb2FkKGZpbGVzKTtcbiAgICAgICAgfSlcbiAgICAgICAgLnRoZW4oZnVuY3Rpb24oY29ubmVjdGlvbikge1xuICAgICAgICAgICAgcmV0dXJuIGNvbm5lY3Rpb24uY2xvc2UoKTtcbiAgICAgICAgfSlcbiAgICAgICAgLnRoZW4oZnVuY3Rpb24oc3VjY2Vzcykge1xuICAgICAgICAgICAgaWYgKHN1Y2Nlc3MpIHtcbiAgICAgICAgICAgICAgICBzZWxmLm5vdGlmeU9ic2VydmVycygnZG93bmxvYWRfZmlsZV9zdWNjZXNzJyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc2VsZi5ub3RpZnlPYnNlcnZlcnMoJ2Rvd25sb2FkX2ZpbGVfZXJyb3InKTtcbiAgICAgICAgfSlcbiAgICAgICAgLmNhdGNoKE5vQ29uZmlndXJhdGlvbkZpbGVGb3VuZEV4Y2VwdGlvbiwgZnVuY3Rpb24oZSkge1xuICAgICAgICAgICAgc2VsZi5ub3RpZnlPYnNlcnZlcnMoJ25vX2NvbmZpZ3VyYXRpb25fZmlsZV9mb3VuZCcpO1xuICAgICAgICB9KVxuICAgICAgICAuY2F0Y2goQ29uZmlndXJhdGlvbkZpbGVOb3RSZWFkYWJsZUV4Y2VwdGlvbiwgZnVuY3Rpb24oZSkge1xuICAgICAgICAgICAgc2VsZi5ub3RpZnlPYnNlcnZlcnMoJ2NvbmZpZ3VyYXRpb25fZmlsZV9ub3RfcmVhZGFibGUnKTtcbiAgICAgICAgfSlcbiAgICAgICAgLmNhdGNoKENvbmZpZ3VyYXRpb25GaWxlU3ludGF4RXJyb3JFeGNlcHRpb24sIGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICAgIHNlbGYubm90aWZ5T2JzZXJ2ZXJzKCdjb25maWd1cmF0aW9uX2ZpbGVfc3ludGF4X2Vycm9yJywgZSk7XG4gICAgICAgIH0pXG4gICAgICAgIC5jYXRjaChDb25uZWN0aW9uRXJyb3JFeGNlcHRpb24sIGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICAgIHNlbGYubm90aWZ5T2JzZXJ2ZXJzKCdjb25uZWN0aW9uX2Vycm9yJywgZSk7XG4gICAgICAgIH0pXG4gICAgICAgIC5jYXRjaChEb3dubG9hZEVycm9yRXhjZXB0aW9uLCBmdW5jdGlvbihlKSB7XG4gICAgICAgICAgICBzZWxmLm5vdGlmeU9ic2VydmVycygnZG93bmxvYWRfZmlsZV9lcnJvcicsIGUpO1xuICAgICAgICB9KVxuICAgICAgICAuY2F0Y2goRGlyZWN0b3J5Q3JlYXRpb25FcnJvckV4Y2VwdGlvbiwgZnVuY3Rpb24oZSkge1xuICAgICAgICAgICAgc2VsZi5ub3RpZnlPYnNlcnZlcnMoJ2RpcmVjdG9yeV9jcmVhdGlvbl9lcnJvcicsIGUpO1xuICAgICAgICB9KVxuICAgICAgICAuY2F0Y2goVHJhbnNmZXJ0RXJyb3JFeGNlcHRpb24sIGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICAgIHNlbGYubm90aWZ5T2JzZXJ2ZXJzKCd0cmFuc2ZlcnRfZmlsZV9lcnJvcicsIGUpO1xuICAgICAgICB9KVxuICAgICAgICAuY2F0Y2goUmVtb3RlRGlyZWN0b3J5Tm90UmVhZGFibGVFeGNlcHRpb24sIGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICAgIHNlbGYubm90aWZ5T2JzZXJ2ZXJzKCdyZW1vdGVfZGlyZWN0b3J5X25vdF9yZWFkYWJsZScsIGUpO1xuICAgICAgICB9KVxuICAgICAgICAuY2F0Y2goZnVuY3Rpb24oZSkge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihlKTtcbiAgICAgICAgfSk7XG59O1xuXG4vKipcbiAqIEdlbmVyYXRlIGEgZGVmYXVsdCBjb25maWd1cmF0aW9uIGZpbGVcbiAqIEFzayB3aGljaCBwcm90b2NvbCB0aGUgdXNlciB3YW50IHRvIHVzZVxuICovXG5EZXBsb3ltZW50TWFuYWdlci5wcm90b3R5cGUuZ2VuZXJhdGVDb25maWdGaWxlID0gZnVuY3Rpb24oKSB7XG4gICAgdmFyIGNvbmZpZ0ZhY3RvcnkgPSBuZXcgQ29uZmlnRmFjdG9yeSgpO1xuXG4gICAgaWYgKGF0b20ucHJvamVjdC5yb290RGlyZWN0b3JpZXMubGVuZ3RoIDwgMSkge1xuICAgICAgICBzZWxmLm5vdGlmeU9ic2VydmVycyhcInByb2plY3Rfbm90X2ZvdW5kXCIpO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdmFyIGNvbmZpZ1BhdGggPSBwYXRoLmpvaW4oXG4gICAgICAgIGF0b20ucHJvamVjdC5yb290RGlyZWN0b3JpZXNbMF0ucGF0aCxcbiAgICAgICAgc2VsZi5jb25maWd1cmF0aW9uRmlsZU5hbWVcbiAgICApO1xuXG4gICAgYXRvbS5jb25maXJtKHtcbiAgICAgICAgbWVzc2FnZTogXCJXaGljaCB0eXBlIG9mIGNvbmZpZ3VyYXRpb24geW91IHdhbnQgdG8gZ2VuZXJhdGUgP1wiLFxuICAgICAgICBkZXRhaWxlZE1lc3NhZ2U6IFwiQmUgY2FyZWZ1bCwgdGhpcyB3aWxsIG92ZXJ3cml0ZSB0aGUgZXhpc3RlbnQgY29uZmlndXJhdGlvbiBmaWxlICFcIixcbiAgICAgICAgYnV0dG9uczoge1xuICAgICAgICAgICAgXCJTRlRQXCI6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBjb25maWdGYWN0b3J5XG4gICAgICAgICAgICAgICAgICAgIC5jcmVhdGVTZnRwQ29uZmlnKClcbiAgICAgICAgICAgICAgICAgICAgLnNhdmUoY29uZmlnUGF0aClcbiAgICAgICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzZWxmLm5vdGlmeU9ic2VydmVycyhcImNvbmZpZ3VyYXRpb25fZmlsZV9jcmVhdGlvbl9zdWNjZXNzXCIpO1xuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAuY2F0Y2goZnVuY3Rpb24oZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5ub3RpZnlPYnNlcnZlcnMoXCJjb25maWd1cmF0aW9uX2ZpbGVfY3JlYXRpb25fZXJyb3JcIiwgZSk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIFwiRlRQXCI6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgIGNvbmZpZ0ZhY3RvcnlcbiAgICAgICAgICAgICAgICAgICAgICAuY3JlYXRlRnRwQ29uZmlnKClcbiAgICAgICAgICAgICAgICAgICAgICAuc2F2ZShjb25maWdQYXRoKVxuICAgICAgICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLm5vdGlmeU9ic2VydmVycyhcImNvbmZpZ3VyYXRpb25fZmlsZV9jcmVhdGlvbl9zdWNjZXNzXCIpO1xuICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5ub3RpZnlPYnNlcnZlcnMoXCJjb25maWd1cmF0aW9uX2ZpbGVfY3JlYXRpb25fZXJyb3JcIiwgZSk7XG4gICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgXCJDYW5jZWxcIjogbnVsbFxuICAgICAgICB9XG4gICAgfSk7XG59O1xuXG4vKipcbiAqIFVwbG9hZCB0aGUgb3BlbiB0YWIgZmlsZVxuICovXG5EZXBsb3ltZW50TWFuYWdlci5wcm90b3R5cGUudXBsb2FkQ3VycmVudEZpbGUgPSBmdW5jdGlvbigpIHtcbiAgICBzZWxmLm5vdGlmeU9ic2VydmVycygnYmVnaW5fdHJhbnNmZXJ0Jyk7XG4gICAgb0ZpbGVNYW5hZ2VyLmdldEN1cnJlbnRGaWxlKClcbiAgICAgICAgLnRoZW4oZnVuY3Rpb24oZmlsZSkge1xuICAgICAgICAgICAgc2VsZi51cGxvYWQoW2ZpbGVdKTtcbiAgICAgICAgfSk7XG59O1xuXG4vKipcbiAqIFVwbG9hZCBvbiBzYXZlXG4gKi9cbkRlcGxveW1lbnRNYW5hZ2VyLnByb3RvdHlwZS51cGxvYWRPblNhdmUgPSBmdW5jdGlvbigpIHtcbiAgICB2YXIgY29uZmlnRmFjdG9yeSA9IG5ldyBDb25maWdGYWN0b3J5KCk7XG4gICAgdmFyIGNvbmZpZ1BhdGggPSBwYXRoLmpvaW4oXG4gICAgICAgIGF0b20ucHJvamVjdC5yb290RGlyZWN0b3JpZXNbMF0ucGF0aCxcbiAgICAgICAgc2VsZi5jb25maWd1cmF0aW9uRmlsZU5hbWVcbiAgICApO1xuXG4gICAgY29uZmlnRmFjdG9yeS5sb2FkQ29uZmlnKGNvbmZpZ1BhdGgpXG4gICAgICAgIC50aGVuKGZ1bmN0aW9uKGNvbmZpZykge1xuICAgICAgICAgICAgaWYgKGNvbmZpZy5nZXRVcGxvYWRPblNhdmUoKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBzZWxmLnVwbG9hZEN1cnJlbnRGaWxlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xufTtcblxuLyoqXG4gKiBEb3dubG9hZCB0aGUgb3BlbiB0YWIgZmlsZVxuICovXG5EZXBsb3ltZW50TWFuYWdlci5wcm90b3R5cGUuZG93bmxvYWRDdXJyZW50RmlsZSA9IGZ1bmN0aW9uKCkge1xuICAgIGF0b20uY29uZmlybSh7XG4gICAgICAgIG1lc3NhZ2U6IFwiWW91IHdpbGwgZG93bmxvYWQgdGhlIGN1cnJlbnQgZmlsZSwgYmUgY2FyZWZ1bCwgaXQgd2lsbCBiZSBvdmVyd3JpdHRlbi5cIixcbiAgICAgICAgYnV0dG9uczoge1xuICAgICAgICAgICAgXCJPdmVyd3JpdGVcIjogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHNlbGYubm90aWZ5T2JzZXJ2ZXJzKCdiZWdpbl90cmFuc2ZlcnQnKTtcbiAgICAgICAgICAgICAgICBvRmlsZU1hbmFnZXIuZ2V0Q3VycmVudEZpbGUoKVxuICAgICAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbihmaWxlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRvd25sb2FkKFtmaWxlXSk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIFwiQ2FuY2VsXCI6IG51bGxcbiAgICAgICAgfVxuICAgIH0pO1xufTtcblxuLyoqXG4gKiBVcGxvYWQgb3BlbiB0YWIgZmlsZXNcbiAqL1xuRGVwbG95bWVudE1hbmFnZXIucHJvdG90eXBlLnVwbG9hZE9wZW5GaWxlcyA9IGZ1bmN0aW9uKCkge1xuICAgIHNlbGYubm90aWZ5T2JzZXJ2ZXJzKCdiZWdpbl90cmFuc2ZlcnQnKTtcbiAgICBvRmlsZU1hbmFnZXIuZ2V0T3BlbkZpbGVzKClcbiAgICAgICAgLnRoZW4oZnVuY3Rpb24oZmlsZXMpIHtcbiAgICAgICAgICAgIHNlbGYudXBsb2FkKGZpbGVzKTtcbiAgICAgICAgfSk7XG59O1xuXG4vKipcbiAqIFVwbG9hZCBhIHRyZWUtdmlldyBzZWxlY3Rpb25cbiAqL1xuRGVwbG95bWVudE1hbmFnZXIucHJvdG90eXBlLnVwbG9hZFNlbGVjdGlvbiA9IGZ1bmN0aW9uKCkge1xuICAgIHNlbGYubm90aWZ5T2JzZXJ2ZXJzKCdiZWdpbl90cmFuc2ZlcnQnKTtcbiAgICBvRmlsZU1hbmFnZXIuZ2V0U2VsZWN0aW9uKHRydWUpXG4gICAgICAgIC50aGVuKGZ1bmN0aW9uKGZpbGVzKSB7XG4gICAgICAgICAgICBzZWxmLnVwbG9hZChmaWxlcyk7XG4gICAgICAgIH0pO1xufTtcblxuLyoqXG4gKiBEb3dubG9hZCBhIHRyZWUtdmlldyBzZWxlY3Rpb25cbiAqL1xuRGVwbG95bWVudE1hbmFnZXIucHJvdG90eXBlLmRvd25sb2FkU2VsZWN0aW9uID0gZnVuY3Rpb24oKSB7XG4gICAgYXRvbS5jb25maXJtKHtcbiAgICAgICAgbWVzc2FnZTogXCJZb3Ugd2lsbCBkb3dubG9hZCBhbGwgeW91ciBzZWxlY3Rpb24sIGJlIGNhcmVmdWwsIGl0IHdpbGwgYmUgb3ZlcndyaXR0ZWQuXCIsXG4gICAgICAgIGJ1dHRvbnM6IHtcbiAgICAgICAgICAgIFwiT3ZlcndyaXRlXCI6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBzZWxmLm5vdGlmeU9ic2VydmVycygnYmVnaW5fdHJhbnNmZXJ0Jyk7XG4gICAgICAgICAgICAgICAgb0ZpbGVNYW5hZ2VyLmdldFNlbGVjdGlvbigpXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKG5vZGVzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRvd25sb2FkKG5vZGVzKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgIFwiQ2FuY2VsXCI6IG51bGxcbiAgICAgICAgfVxuICAgIH0pO1xufTtcblxubW9kdWxlLmV4cG9ydHMgPSBEZXBsb3ltZW50TWFuYWdlcjtcbiJdfQ==